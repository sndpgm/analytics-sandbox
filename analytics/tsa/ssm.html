
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>状態空間モデル — Analytics Study Blog</title>
<!-- Loaded before other Sphinx assets -->
<link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="../../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../../_static/mystnb.css" rel="stylesheet" type="text/css">
<link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/graphviz.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/sphinx-codeautolink.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
<script src="../../_static/jquery.js"></script>
<script src="../../_static/underscore.js"></script>
<script src="../../_static/doctools.js"></script>
<script src="../../_static/clipboard.min.js"></script>
<script src="../../_static/copybutton.js"></script>
<script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../../_static/togglebutton.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
<script src="../../_static/design-tabs.js"></script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
<script async="async" src="../../_static/sphinx-thebe.js"></script>
<script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link href="../../genindex.html" rel="index" title="Index">
<link href="../../search.html" rel="search" title="Search"/>
<link href="../math/calculus.html" rel="next" title="微分積分学"/>
<link href="arima.html" rel="prev" title="ARIMAモデル系"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../../_static/logo.png"/>
<h1 class="site-logo" id="site-title">Analytics Study Blog</h1>
</a>
</div><form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<ul class="nav bd-sidenav bd-sidenav__home-link">
<li class="toctree-l1">
<a class="reference internal" href="../../intro.html">
                    Welcome to my Analytics Sandbox
                </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  確率変数と確率分布
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../distribution/rvs.html">
   確率変数
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../distribution/dist.html">
   確率分布
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../distribution/mdist.html">
   多変量確率分布
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  回帰モデル
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../regression/blm.html">
   ベイズ線形回帰モデル
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  時系列モデル
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="ts.html">
   時系列データ
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="arma.html">
   ARMAモデル系
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="arima.html">
   ARIMAモデル系
  </a>
</li>
<li class="toctree-l1 current active">
<a class="current reference internal" href="#">
   状態空間モデル
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  補足
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../math/calculus.html">
   微分積分学
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../math/linear_algebra.html">
   線形代数学
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../api/sandbox/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
     sandbox
    </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../api/sandbox/datamodel/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
       sandbox.datamodel
      </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/datamodel/base/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datamodel.base
        </span>
</code>
</a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/datamodel/ts_datamodel/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datamodel.ts_datamodel
        </span>
</code>
</a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/datamodel/ts_simulator/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datamodel.ts_simulator
        </span>
</code>
</a>
</li>
</ul>
</input></li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
       sandbox.datasets
      </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/air_passengers/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.air_passengers
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/air_passengers/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.air_passengers.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/blsallfood/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.blsallfood
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/blsallfood/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.blsallfood.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/hakusan/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.hakusan
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/hakusan/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.hakusan.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/maxtemp/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.maxtemp
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/maxtemp/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.maxtemp.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/mye1f/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.mye1f
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
<label for="toctree-checkbox-8">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/mye1f/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.mye1f.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/nikkei225/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.nikkei225
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
<label for="toctree-checkbox-9">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/nikkei225/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.nikkei225.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/rtf/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.rtf
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
<label for="toctree-checkbox-10">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/rtf/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.rtf.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/datasets/whard/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.whard
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
<label for="toctree-checkbox-11">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/datasets/whard/data/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.datasets.whard.data
          </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/datasets/utils/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.datasets.utils
        </span>
</code>
</a>
</li>
</ul>
</input></li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../api/sandbox/graphics/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
       sandbox.graphics
      </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
<label for="toctree-checkbox-12">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/graphics/ts_grapher/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.graphics.ts_grapher
        </span>
</code>
</a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/graphics/utils/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.graphics.utils
        </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../api/sandbox/metrics/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
       sandbox.metrics
      </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
<label for="toctree-checkbox-13">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/metrics/score/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.metrics.score
        </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../api/sandbox/tests/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
       sandbox.tests
      </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
<label for="toctree-checkbox-14">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3 has-children">
<a class="reference internal" href="../../api/sandbox/tests/datasets/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.tests.datasets
        </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
<label for="toctree-checkbox-15">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l4">
<a class="reference internal" href="../../api/sandbox/tests/datasets/test_utils/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
           sandbox.tests.datasets.test_utils
          </span>
</code>
</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../api/sandbox/tsa/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
       sandbox.tsa
      </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
<label for="toctree-checkbox-16">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/tsa/base/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.tsa.base
        </span>
</code>
</a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/tsa/sarimax/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.tsa.sarimax
        </span>
</code>
</a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/tsa/ssm/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.tsa.ssm
        </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../api/sandbox/utils/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
       sandbox.utils
      </span>
</code>
</a>
<input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
<label for="toctree-checkbox-17">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/utils/tools/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.utils.tools
        </span>
</code>
</a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../api/sandbox/utils/validation/index.html">
<code class="xref py py-mod docutils literal notranslate">
<span class="pre">
         sandbox.utils.validation
        </span>
</code>
</a>
</li>
</ul>
</li>
</ul>
</input></li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
<button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-rocket"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://mybinder.org/v2/gh/sndpgm/analytics-sandbox/main?urlpath=tree/docs/analytics/tsa/ssm.ipynb" title="Launch on Binder">
<span class="headerbtn__icon-container">
<img src="../../_static/images/logo_binder.svg"/>
</span>
<span class="headerbtn__text-container">Binder</span>
</a>
</li>
</ul>
</div>
</div>
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<div class="menu-dropdown menu-dropdown-repository-buttons">
<button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
<i class="fab fa-github"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/sndpgm/analytics-sandbox" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
<span class="headerbtn__text-container">repository</span>
</a>
</li>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/sndpgm/analytics-sandbox/issues/new?title=Issue%20on%20page%20%2Fanalytics/tsa/ssm.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
<span class="headerbtn__icon-container">
<i class="fas fa-lightbulb"></i>
</span>
<span class="headerbtn__text-container">open issue</span>
</a>
</li>
</ul>
</div>
</div>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/analytics/tsa/ssm.ipynb" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.ipynb</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
   1. 一般的な状態空間モデルの定義
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id3">
     1.1 定義 (状態空間モデル)
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#alpha-t">
       状態
       <span class="math notranslate nohighlight">
        \(\alpha_t\)
       </span>
       はマルコフ連鎖である
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#alpha-t-y-t-y-t-alpha-t">
       状態
       <span class="math notranslate nohighlight">
        \(\alpha_t\)
       </span>
       の条件の下で
       <span class="math notranslate nohighlight">
        \(y_t\)
       </span>
       は独立で
       <span class="math notranslate nohighlight">
        \(y_t\)
       </span>
       は
       <span class="math notranslate nohighlight">
        \(\alpha_t\)
       </span>
       のみに依存する
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id4">
     1.2 定理 (状態空間モデルの同時分布)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id5">
   2. 一般的な状態空間モデルの逐次的求解
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#theta">
     2.1 プロシージャ (パラメータ
     <span class="math notranslate nohighlight">
      \(\theta\)
     </span>
     の推定)
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id6">
       2.1.1 命題 (対数尤度関数)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id7">
       2.1.2 命題 (パラメータを確率変数とは考えない場合の推定)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id8">
       2.1.3 命題 (パラメータを確率変数として考える場合の推定)
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id9">
     2.2 プロシージャ (状態の推定および観測値の予測)
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id10">
       2.2.1 命題 (フィルタリング分布の推定)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id11">
       2.2.2 命題 (予測分布の予測)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id12">
       2.2.3 命題 (平滑化分布の推定)
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id13">
   3. 線形ガウス状態空間モデル (動的線形モデル)
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id14">
     3.1 定義 (線形ガウス状態空間モデルの一般式)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id15">
     3.2 例 (ローカルレベルモデル)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id16">
   4. カルマンフィルタ
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tsa-ssm-kalman-filtering">
     4.1 命題 (カルマンフィルタリング)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python">
     4.2 例 (python によるカルマンフィルタの実装)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tsa-ssm-kalman-forecasting">
     4.3 命題 (カルマン予測)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id19">
     4.4 例 (python によるカルマン予測の実装)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tsa-ssm-kalman-smoothing">
     4.5 命題 (カルマン平滑化)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id21">
     4.6 例 (python によるカルマン平滑化の実装)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#statsmodels">
   5. statsmodels による状態空間モデル
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#unobservedcomponents">
     5.1 例 (UnobservedComponentsによる状態空間モデル構築)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlemodel-mlemodel">
     5.2 例 (MLEModelでのカスタム構築: MLEModel の基本説明)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlemodel">
     5.3 例 (MLEModelでのカスタム構築: ローカル線形トレンドモデル)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlemode">
     5.4 例 (MLEModeでのカスタム構築: 時変回帰モデル)
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>状態空間モデル</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
   1. 一般的な状態空間モデルの定義
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id3">
     1.1 定義 (状態空間モデル)
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#alpha-t">
       状態
       <span class="math notranslate nohighlight">
        \(\alpha_t\)
       </span>
       はマルコフ連鎖である
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#alpha-t-y-t-y-t-alpha-t">
       状態
       <span class="math notranslate nohighlight">
        \(\alpha_t\)
       </span>
       の条件の下で
       <span class="math notranslate nohighlight">
        \(y_t\)
       </span>
       は独立で
       <span class="math notranslate nohighlight">
        \(y_t\)
       </span>
       は
       <span class="math notranslate nohighlight">
        \(\alpha_t\)
       </span>
       のみに依存する
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id4">
     1.2 定理 (状態空間モデルの同時分布)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id5">
   2. 一般的な状態空間モデルの逐次的求解
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#theta">
     2.1 プロシージャ (パラメータ
     <span class="math notranslate nohighlight">
      \(\theta\)
     </span>
     の推定)
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id6">
       2.1.1 命題 (対数尤度関数)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id7">
       2.1.2 命題 (パラメータを確率変数とは考えない場合の推定)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id8">
       2.1.3 命題 (パラメータを確率変数として考える場合の推定)
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id9">
     2.2 プロシージャ (状態の推定および観測値の予測)
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id10">
       2.2.1 命題 (フィルタリング分布の推定)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id11">
       2.2.2 命題 (予測分布の予測)
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id12">
       2.2.3 命題 (平滑化分布の推定)
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id13">
   3. 線形ガウス状態空間モデル (動的線形モデル)
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id14">
     3.1 定義 (線形ガウス状態空間モデルの一般式)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id15">
     3.2 例 (ローカルレベルモデル)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#id16">
   4. カルマンフィルタ
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tsa-ssm-kalman-filtering">
     4.1 命題 (カルマンフィルタリング)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python">
     4.2 例 (python によるカルマンフィルタの実装)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tsa-ssm-kalman-forecasting">
     4.3 命題 (カルマン予測)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id19">
     4.4 例 (python によるカルマン予測の実装)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tsa-ssm-kalman-smoothing">
     4.5 命題 (カルマン平滑化)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id21">
     4.6 例 (python によるカルマン平滑化の実装)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#statsmodels">
   5. statsmodels による状態空間モデル
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#unobservedcomponents">
     5.1 例 (UnobservedComponentsによる状態空間モデル構築)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlemodel-mlemodel">
     5.2 例 (MLEModelでのカスタム構築: MLEModel の基本説明)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlemodel">
     5.3 例 (MLEModelでのカスタム構築: ローカル線形トレンドモデル)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mlemode">
     5.4 例 (MLEModeでのカスタム構築: 時変回帰モデル)
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>状態空間モデル<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h1>
<section id="id2">
<h2>1. 一般的な状態空間モデルの定義<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h2>
<p>最初に抽象的ではあるが一般的な状態空間モデルの定義を行う.</p>
<section id="id3">
<h3>1.1 定義 (状態空間モデル)<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h3>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        状態空間モデルの仮定
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><strong>状態空間モデル</strong> (state space model) とは <span class="math notranslate nohighlight">\(\mathbb{R}^m\)</span> 上の値をとる時系列 <span class="math notranslate nohighlight">\(\alpha_t \ (t=0, 1, \dots)\)</span> と <span class="math notranslate nohighlight">\(\mathbb{R}^p\)</span> 上の値をとる時系列 <span class="math notranslate nohighlight">\(y_t \ (t = 1, 2, \dots)\)</span> からなり以下の 2 仮定を満たすモデルを指す.</p>
<ol class="simple">
<li><p>状態 <span class="math notranslate nohighlight">\(\alpha_t\)</span> はマルコフ連鎖である.</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha_t\)</span> の条件の下で <span class="math notranslate nohighlight">\(y_t\)</span> は独立であり, <span class="math notranslate nohighlight">\(y_t\)</span> は <span class="math notranslate nohighlight">\(\alpha_t\)</span> のみに依存する.</p></li>
</ol>
</div>
<p>方程式によって表現すると以下のように書ける.</p>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        状態空間モデルの方程式表現
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><span class="math notranslate nohighlight">\(F(\cdot), G(\cdot)\)</span> を任意の関数とし, <span class="math notranslate nohighlight">\(\varepsilon_t\)</span> を観測誤差, <span class="math notranslate nohighlight">\(\eta_t\)</span> を状態誤差と呼ばれ, 以下のように表現される.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        y_t &amp;= F(\alpha_t, \varepsilon_t) \\
        \alpha_t &amp;= G(\alpha_{t-1}, \eta_t)
    \end{align*}
\end{split}\]</div>
<p>このとき上式を<strong>観測方程式</strong> (observation equation), 下式を<strong>状態方程式</strong> (state equation) または <strong>システム方程式</strong> (system equation) という.</p>
</div>
<p>状態空間モデルにおいて状態 <span class="math notranslate nohighlight">\(\alpha_t\)</span> と観測値 <span class="math notranslate nohighlight">\(y_t\)</span> の関係性は以下の<strong>非巡回的有向グラフ</strong> (directed acyclic graph, DAG) によって表現される関係にある.</p>
<figure class="align-default" id="ssm-dag">
<a class="bg-primary mb-1 reference internal image-reference" href="../../_images/ssm-dag.png"><img alt="ssm-dag" class="bg-primary mb-1" src="../../_images/ssm-dag.png" style="width: 600px;"/></a>
<figcaption>
<p><span class="caption-number">Fig. 1 </span><span class="caption-text">状態変数と観測値の関係</span><a class="headerlink" href="#ssm-dag" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>以下では状態空間モデルの仮定をDAG並びに確率分布の観点で具体化する. 条件付分布については <a class="reference internal" href="../distribution/mdist.html#dist-mdist-marginal-conditional"><span class="std std-ref">3. 周辺分布と条件付分布</span></a> を参照のこと.</p>
<section id="alpha-t">
<span id="tsa-ssm-definition-definition-markov"></span><h4>状態 <span class="math notranslate nohighlight">\(\alpha_t\)</span> はマルコフ連鎖である<a class="headerlink" href="#alpha-t" title="Permalink to this headline">#</a></h4>
<p>下記のように <span class="math notranslate nohighlight">\(\alpha_t\)</span> は <span class="math notranslate nohighlight">\(\alpha_{t-1}\)</span> が確定するとその確率分布も定まる. すなわち</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(\alpha_t | \alpha_{0:t-1}, y_{1:t-1}) = f(\alpha_t | \alpha_{t-1}).
    \end{align*}
\]</div>
<figure class="align-default" id="ssm-dag-markov">
<a class="bg-primary mb-1 reference internal image-reference" href="../../_images/ssm-dag-markov.png"><img alt="ssm-dag-markov" class="bg-primary mb-1" src="../../_images/ssm-dag-markov.png" style="width: 600px;"/></a>
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">DAGによるマルコフ性 (網掛けの変数が与えられると線で囲まれた変数が独立となる)</span><a class="headerlink" href="#ssm-dag-markov" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="alpha-t-y-t-y-t-alpha-t">
<span id="tsa-ssm-definition-definition-cond-independent"></span><h4>状態 <span class="math notranslate nohighlight">\(\alpha_t\)</span> の条件の下で <span class="math notranslate nohighlight">\(y_t\)</span> は独立で <span class="math notranslate nohighlight">\(y_t\)</span> は <span class="math notranslate nohighlight">\(\alpha_t\)</span> のみに依存する<a class="headerlink" href="#alpha-t-y-t-y-t-alpha-t" title="Permalink to this headline">#</a></h4>
<p>下記のように <span class="math notranslate nohighlight">\(\alpha_t\)</span> が確定すると <span class="math notranslate nohighlight">\(y_t\)</span> の確率分布も定まる. すなわち</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(y_t | \alpha_{0:t}, y_{1:t-1}) = f(y_t | \alpha_t).
    \end{align*}
\]</div>
<figure class="align-default" id="ssm-dag-cond-independent">
<a class="bg-primary mb-1 reference internal image-reference" href="../../_images/ssm-dag-cond-independent.png"><img alt="ssm-dag-cond-independent" class="bg-primary mb-1" src="../../_images/ssm-dag-cond-independent.png" style="width: 600px;"/></a>
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">DAGに観測値の条件付独立性 (網掛けの変数が与えられると線で囲まれた変数が独立となる)</span><a class="headerlink" href="#ssm-dag-cond-independent" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="id4">
<h3>1.2 定理 (状態空間モデルの同時分布)<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h3>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        状態空間モデルの同時分布
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p>状態空間モデルの同時分布 <span class="math notranslate nohighlight">\(f(\alpha_{0:n}, y_{1:n})\)</span> は以下のように表現できる.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(\alpha_{0:n}, y_{1:n}) = f(x_0) \prod_{t=1}^{n}{f(y_t | x_t)f(x_t | x_{t-1})}
    \end{align*}
\]</div>
<p>上記において初期状態に関する事前分布 <span class="math notranslate nohighlight">\(f(x_0)\)</span>, 観測方程式 (観測値と状態に関する方程式) の確率分布 <span class="math notranslate nohighlight">\(f(y_t | x_t)\)</span>, 状態方程式 (状態に関する方程式) の確率分布 <span class="math notranslate nohighlight">\(f(x_t | x_{t-1})\)</span> によって決まることが分かる.</p>
</div>
<p><u>証明</u></p>
<p><a class="reference internal" href="../distribution/mdist.html#conditional-distribution"><span class="std std-ref">条件付分布による乗法定理</span></a> を用いて計算を進める.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f(\alpha_{0:n}, y_{1:n}) 
            &amp;= f(\alpha_{0:n}, y_n, y_{1:n-1}) \\
            &amp;= f(y_n | \alpha_{0:n}, y_{1:n-1}) f(\alpha_{0:n}, y_{1:n-1}) \quad (\because \ \text{条件付分布の乗法定理}) \\
            &amp;= f(y_n | \alpha_{0:n}, y_{1:n-1}) f(\alpha_n, \alpha_{0:n-1}, y_{1:n-1}) \\
            &amp;= f(y_n | \alpha_{0:n}, y_{1:n-1}) f(\alpha_n | \alpha_{0:n-1}, y_{1:n-1}) f(\alpha_{0:n-1}, y_{1:n-1}) \quad (\because \ \text{条件付分布の乗法定理})
    \end{align*}
\end{split}\]</div>
<p>つまり <span class="math notranslate nohighlight">\(f(\alpha_{0:n}, y_{1:n})\)</span> から <span class="math notranslate nohighlight">\(f(\alpha_{0:n-1}, y_{1:n-1})\)</span> に変換すると <span class="math notranslate nohighlight">\(f(y_n | \alpha_{0:n}, y_{1:n-1}) f(\alpha_n | \alpha_{0:n-1}, y_{1:n-1})\)</span> が係数部分にかけられる. このことを繰り返し <span class="math notranslate nohighlight">\(f(\alpha_{0:1}, y_1)\)</span> まで行うと</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f(\alpha_{0:n}, y_{1:n}) 
            &amp;= \biggl( \prod_{t=2}^{n}{ f(y_t | \alpha_{0:t}, y_{1:t-1}) f(\alpha_t | \alpha_{0:t-1}, y_{1:t-1}) } \biggr) f(\alpha_{0:1}, y_1) \\
            &amp;= \biggl( \prod_{t=2}^{n}{ f(y_t | \alpha_{0:t}, y_{1:t-1}) f(\alpha_t | \alpha_{0:t-1}, y_{1:t-1}) } \biggr) f(y_1 | \alpha_{0:1}) f(\alpha_1 | \alpha_0) f(\alpha_0) \quad (\because \ \text{条件付分布の乗法定理})
    \end{align*}
\end{split}\]</div>
<p>状態空間モデルの仮定より <span class="math notranslate nohighlight">\(f(y_t | \alpha_{0:t}, y_{1:t-1}) = f(y_t | \alpha_t)\)</span>, <span class="math notranslate nohighlight">\(f(\alpha_t | \alpha_{0:t-1}, y_{1:t-1}) = f(\alpha_t | \alpha_{t-1})\)</span> より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f(\alpha_{0:n}, y_{1:n}) 
            &amp;= \biggl( \prod_{t=2}^{n}{ f(y_t | \alpha_t) f(\alpha_t | \alpha_{t-1}) } \biggr) f(y_1 | \alpha_{0:1}) f(\alpha_1 | \alpha_0) f(\alpha_0) \\
            &amp;= f(\alpha_0) \prod_{t=1}^{n}{ f(y_t | \alpha_t) f(\alpha_t | \alpha_{t-1}) }.
    \end{align*}
\end{split}\]</div>
</section>
</section>
<section id="id5">
<h2>2. 一般的な状態空間モデルの逐次的求解<a class="headerlink" href="#id5" title="Permalink to this headline">#</a></h2>
<p>状態空間モデルは<a class="reference internal" href="#tsa-ssm-definition-definition-equation-expression"><span class="std std-ref">前述</span></a>した通り, 以下のように表現できる. ただし, 状態変数と観測値以外の未知パラメータ (誤差項を含む) は <span class="math notranslate nohighlight">\(\theta\)</span> にまとめている.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        y_t &amp;= F(\alpha_t, \theta) \\
        \alpha_t &amp;= G(\alpha_{t-1}, \theta)        
    \end{align*}
\end{split}\]</div>
<p>このとき状態空間モデルの逐次的解析として以下のステップで構成される.</p>
<ol class="simple">
<li><p>パラメータ <span class="math notranslate nohighlight">\(\theta\)</span> の推定</p></li>
<li><p>状態の推定および観測値の予測</p></li>
</ol>
<section id="theta">
<h3>2.1 プロシージャ (パラメータ <span class="math notranslate nohighlight">\(\theta\)</span> の推定)<a class="headerlink" href="#theta" title="Permalink to this headline">#</a></h3>
<section id="id6">
<h4>2.1.1 命題 (対数尤度関数)<a class="headerlink" href="#id6" title="Permalink to this headline">#</a></h4>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        状態空間モデルの対数尤度関数
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p>全体の尤度関数を <span class="math notranslate nohighlight">\(L(y_{1:n};\theta)\)</span> とすれば対数尤度関数は以下で表現される.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        \log{L(y_{1:n};\theta)} = \sum_{t=1}^{n}{\log{L(y_t | y_{1:t-1} ; \theta)}}
    \end{align*}
\]</div>
</div>
<p><u>証明</u></p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        L(y_{1:n};\theta) &amp;= L(y_n | y_{1:n-1};\theta)L(y_{1:n-1};\theta) \\
                          &amp;= L(y_n | y_{1:n-1};\theta)L(y_{n-1} | y_{1:n-2};\theta)L(y_{1:n-2};\theta) \\
                          &amp;\cdots \\
                          &amp;= \prod_{t=1}^{n}{L(y_t|y_{1:t-1};\theta)} \quad (\textstyle ただし \ L(y_1|y_{1:0};\theta) = L(y_1; \theta) \ とする)
    \end{align*}
\end{split}\]</div>
<p>となり上記に対数を取れば求められる.<br/>
　この対数尤度関数を用いてパラメータを推定する.</p>
</section>
<section id="id7">
<h4>2.1.2 命題 (パラメータを確率変数とは考えない場合の推定)<a class="headerlink" href="#id7" title="Permalink to this headline">#</a></h4>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        パラメータを確率変数とは考えない場合のパラメータ推定
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p>状態空間モデルにおけるパラメータ推定値 <span class="math notranslate nohighlight">\(\hat{\theta}\)</span> は<strong>最尤推定法</strong> (maximum likelihood estimation; MLE) によって求められる.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        \hat{\theta} =
            \underset{\theta}{\operatorname{argmax}} \log{L(y_{1:n};\theta)} = \underset{\theta}{\operatorname{argmax}} \sum_{t=1}^{n}{\log{L(y_t | y_{1:t-1} ; \theta)}}
    \end{align*}
\]</div>
</div>
<p>具体的な数値計算の手法としては</p>
<ul class="simple">
<li><p>準ニュートン法 (quasi-Newton method)</p></li>
<li><p>EMアルゴリズム (EM; expectation maximization)</p></li>
</ul>
<p>で実施.</p>
</section>
<section id="id8">
<h4>2.1.3 命題 (パラメータを確率変数として考える場合の推定)<a class="headerlink" href="#id8" title="Permalink to this headline">#</a></h4>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        パラメータを確率変数として考える場合のパラメータ推定
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p>状態空間モデルにおけるパラメータ推定値 <span class="math notranslate nohighlight">\(\hat{\theta}\)</span> は<strong>最大事後確率推定</strong> (maximum a posteriori estimation; MAP) によって求められる.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        \hat{\theta} =
            \underset{\theta}{\operatorname{argmax}} \log{L(\theta | y_{1:t})} \propto 
            \underset{\theta}{\operatorname{argmax}} \{ \log{L(y_{1:t} | \theta)} + \log{L(\theta)} \}
    \end{align*}
\]</div>
</div></section>
</section>
<section id="id9">
<h3>2.2 プロシージャ (状態の推定および観測値の予測)<a class="headerlink" href="#id9" title="Permalink to this headline">#</a></h3>
<p>状態の推定および観測値の予測において</p>
<ol class="simple">
<li><p><strong>フィルタリング</strong> (filtering) : 時点 <span class="math notranslate nohighlight">\(t\)</span> までの観測値 <span class="math notranslate nohighlight">\(y_{1:t}\)</span> に基づいて時点 <span class="math notranslate nohighlight">\(t\)</span> の状態 <span class="math notranslate nohighlight">\(\alpha_t\)</span> を推定</p></li>
<li><p><strong>平滑化</strong> (smoothing) : 与えられたすべての観測値 <span class="math notranslate nohighlight">\(y_{1:n}\)</span> を用いて各時点の状態 <span class="math notranslate nohighlight">\(\alpha_1, \dots, \alpha_n\)</span> を推定</p></li>
<li><p><strong>予測</strong> (forecasting) : フィルタリングの最終時点 <span class="math notranslate nohighlight">\(t=n\)</span> から先の時点へと進めた将来の状態, 観測値に対する予測</p></li>
</ol>
<p>の 3 問題が存在する. さらに言い換えると</p>
<ol class="simple">
<li><p><strong>フィルタリング</strong> (filtering) : フィルタリング分布 <span class="math notranslate nohighlight">\(f(\alpha_t | y_{1:t})\)</span> を推定</p></li>
<li><p><strong>平滑化</strong> (smoothing) : 平滑化分布 <span class="math notranslate nohighlight">\(f(\alpha_t | y_{1:n}) \ (1 \leq t \leq n)\)</span> を推定</p></li>
<li><p><strong>予測</strong> (forecasting) : 予測分布 <span class="math notranslate nohighlight">\(f(\alpha_{t+k} | y_{1:t})  \ (k \geq 1)\)</span> を予測</p></li>
</ol>
<p>とも言える.</p>
<section id="id10">
<h4>2.2.1 命題 (フィルタリング分布の推定)<a class="headerlink" href="#id10" title="Permalink to this headline">#</a></h4>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        フィルタリング
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><strong>フィルタリング</strong> (filtering) によって分布 <span class="math notranslate nohighlight">\(f(\alpha_{t-1}|y_{1:t-1})\)</span> を用いて <span class="math notranslate nohighlight">\(f(\alpha_{t-1}|y_{1:t-1})\)</span> を取得するには以下の漸化式による計算を実施すればよい.</p>
<p>(a) <strong>1期先予測分布</strong> (one-step ahead predict distribution) <span class="math notranslate nohighlight">\(f(\alpha_t | y_{1:t-1})\)</span> を予測.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(\alpha_t | y_{1:t-1}) = \int {f(\alpha_t | \alpha_{t-1}) f(\alpha_{t-1} | y_{1:t-1}) d\alpha_{t-1} }
    \end{align*}
\]</div>
<p>(b) <strong>1期先予測尤度</strong> (one-step ahead predict likelihood) <span class="math notranslate nohighlight">\(f(y_t | y_{1:t-1})\)</span> を予測.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(y_t | y_{1:t-1}) = \int {f(y_t | \alpha_{t}) f(\alpha_{t} | y_{1:t-1}) d\alpha_{t} }
    \end{align*}
\]</div>
<p>(c) データ <span class="math notranslate nohighlight">\(y_t\)</span> を用いて<strong>フィルタリング分布</strong> (filtering distribution) <span class="math notranslate nohighlight">\(f(x_t | y_{1:t})\)</span> を推定.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(\alpha_t | y_{1:t}) = f(\alpha_t | y_{1:t-1}) \frac{f(y_t | \alpha_{t})}{f(y_t | y_{1:t-1})}
    \end{align*}
\]</div>
</div>
<p><u>証明</u></p>
<p>(a)~(c) の数式を導出する. (c) については<a class="reference internal" href="../distribution/mdist.html#conditional-distribution"><span class="std std-ref">乗法定理</span></a>より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f( \alpha_{t} | y_{1:t} ) 
            &amp;= f( \alpha_{t} | y_{t}, y_{1:t-1} ) \\
            &amp;= \frac{ f( \alpha_{t}, y_t | y_{1:t-1} ) }{ f( y_{t} | y_{1:t-1} ) } \quad (\because \ \textstyle 乗法定理) \\
            &amp;= \frac{ f( y_{t} | \alpha_{t}, y_{1:t-1} ) f( \alpha_{t} | y_{1:t-1} ) }{ f( y_{t} | y_{1:t-1} ) } \quad (\because \ \textstyle 乗法定理)
    \end{align*}
\end{split}\]</div>
<p>上式は <a class="reference internal" href="#tsa-ssm-definition-definition-cond-independent"><span class="std std-ref"><span class="math notranslate nohighlight">\(\alpha_t\)</span> が与えられた条件の下で <span class="math notranslate nohighlight">\(y_t\)</span> と <span class="math notranslate nohighlight">\(y_{1:t-1}\)</span> は独立である</span></a>ことを利用して <span class="math notranslate nohighlight">\(f( y_{t} | \alpha_{t}, y_{1:t-1} ) = f( y_{t} | \alpha_{t} )\)</span> となり与式が導出される.</p>
<p>(a) について<a class="reference internal" href="../distribution/mdist.html#marginal-distribution"><span class="std std-ref">周辺化</span></a>を踏まえ</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f( \alpha_{t} | y_{1:t-1} ) 
            &amp;= \int { f( \alpha_{t}, \alpha_{t-1} | y_{1:t-1} ) d\alpha_{t-1} } \quad (\because \ \textstyle 周辺化) \\
            &amp;= \int { f( \alpha_{t} | \alpha_{t-1}, y_{1:t-1} ) f( \alpha_{t-1} | y_{1:t-1} )  d\alpha_{t-1} } \quad (\because \ \textstyle 乗法定理)
    \end{align*}
\end{split}\]</div>
<p>上式について <a class="reference internal" href="#tsa-ssm-definition-definition-markov"><span class="std std-ref"><span class="math notranslate nohighlight">\(\alpha_t\)</span> のマルコフ性</span></a>を利用して <span class="math notranslate nohighlight">\(f( \alpha_{t} | \alpha_{t-1}, y_{1:t-1} ) = f( \alpha_{t} | \alpha_{t-1} )\)</span> となり与式が導出される.</p>
<p>最後に (b) についても<a class="reference internal" href="../distribution/mdist.html#marginal-distribution"><span class="std std-ref">周辺化</span></a>, <a class="reference internal" href="../distribution/mdist.html#conditional-distribution"><span class="std std-ref">乗法定理</span></a>および<a class="reference internal" href="#tsa-ssm-definition-definition-cond-independent"><span class="std std-ref"><span class="math notranslate nohighlight">\(\alpha_t\)</span> が与えられた条件の下で <span class="math notranslate nohighlight">\(y_t\)</span> と <span class="math notranslate nohighlight">\(y_{1:t-1}\)</span> は独立である</span></a>ことを利用して導出ができる.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f( y_{t} | y_{1:t-1} ) 
            &amp;= \int { f( y_{t}, \alpha_{t} | y_{1:t-1} ) d\alpha_{t} } \quad (\because \ \textstyle 周辺化) \\
            &amp;= \int { f( y_{t} | \alpha_{t}, y_{1:t-1} ) f( \alpha_{t} | y_{1:t-1} ) d\alpha_{t} } \quad (\because \ \textstyle 乗法定理) \\
            &amp;= \int { f( y_{t} | \alpha_{t} ) f( \alpha_{t} | y_{1:t-1} ) d\alpha_{t} } \quad (\because \ \textstyle 条件付独立性)
    \end{align*}
\end{split}\]</div>
</section>
<section id="id11">
<h4>2.2.2 命題 (予測分布の予測)<a class="headerlink" href="#id11" title="Permalink to this headline">#</a></h4>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        予測
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><strong>予測</strong> (forecasting) によって分布 <span class="math notranslate nohighlight">\(f(\alpha_{t}|y_{1:t})\)</span> を用いて <span class="math notranslate nohighlight">\(f(\alpha_{t+k}|y_{1:t})\)</span> を取得するプロシージャは以下の漸化式を更新すればよい.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(\alpha_{t+k} | y_{1:t}) = \int {f(\alpha_{t+k} | \alpha_{t+k-1}) f(\alpha_{t+k-1} | y_{1:t}) d\alpha_{t+k-1} }
    \end{align*}
\]</div>
</div>
<p><u>証明</u></p>
<p><a class="reference internal" href="../distribution/mdist.html#marginal-distribution"><span class="std std-ref">周辺化</span></a>, <a class="reference internal" href="../distribution/mdist.html#conditional-distribution"><span class="std std-ref">乗法定理</span></a>, <a class="reference internal" href="#tsa-ssm-definition-definition-markov"><span class="std std-ref"><span class="math notranslate nohighlight">\(\alpha_t\)</span> のマルコフ性</span></a>を利用して</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f(\alpha_{t+k} | y_{1:t}) 
            &amp;= \int { f( \alpha_{t+k}, \alpha_{t+k-1} | y_{1:t}) d \alpha_{t+k-1} } \quad (\because \ \textstyle 周辺化) \\
            &amp;= \int { f( \alpha_{t+k} | \alpha_{t+k-1}, y_{1:t}) f( \alpha_{t+k-1} | y_{1:t})  d \alpha_{t+k-1} } \quad (\because \ \textstyle 乗法定理) \\
            &amp;= \int {f(\alpha_{t+k} | \alpha_{t+k-1}) f(\alpha_{t+k-1} | y_{1:t}) d\alpha_{t+k-1} }. \quad (\because \ \textstyle 状態のマルコフ性)
    \end{align*}
\end{split}\]</div>
</section>
<section id="id12">
<h4>2.2.3 命題 (平滑化分布の推定)<a class="headerlink" href="#id12" title="Permalink to this headline">#</a></h4>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        平滑化
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><strong>平滑化</strong> (smoothing) はフィルタリング分布 <span class="math notranslate nohighlight">\(f(\alpha_{t}|y_{1:n})\)</span> 1 期先のフィルタリング分布<span class="math notranslate nohighlight">\(f(\alpha_{t+1}|y_{1:n})\)</span> を用いて <span class="math notranslate nohighlight">\(f(\alpha_{t+k}|y_{1:t})\)</span> を取得するプロシージャは以下の漸化式を更新すればよい.</p>
<div class="math notranslate nohighlight">
\[
    \begin{align*}
        f(\alpha_{t} | y_{1:n}) = f( \alpha_{t} | y_{1:t} ) \int { \frac{ f(\alpha_{t+1} | \alpha_{t}) }{ f(\alpha_{t+1} | y_{1:t}) } f(\alpha_{t+1} | y_{1:n}) d\alpha_{t+1} }
    \end{align*}
\]</div>
</div>
<p><u>証明</u></p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f( \alpha_{t} | y_{1:n})
            &amp;= \int { f( \alpha_{t}, \alpha_{t+1} | y_{1:n} ) d \alpha_{t+1} } \quad (\because \ \textstyle 周辺化) \\
            &amp;= \int { f( \alpha_{t} | \alpha_{t+1}, y_{1:n} ) f( \alpha_{t+1} | y_{1:n} )  d \alpha_{t+1} } \quad (\because \ \textstyle 乗法定理) \\
            &amp;= \int { f( \alpha_{t} | \alpha_{t+1}, y_{1:t} ) f( \alpha_{t+1} | y_{1:n} )  d \alpha_{t+1} } \quad (\because \ \textstyle 条件付独立性) \\
            &amp;= \int { \frac{ f( \alpha_{t}, \alpha_{t+1} | y_{1:t} ) }{ f( \alpha_{t+1} | y_{1:t} ) } f( \alpha_{t+1} | y_{1:n} )  d \alpha_{t+1} } \quad (\because \ \textstyle 乗法定理) \\
            &amp;= \int { \frac{ f( \alpha_{t+1} | \alpha_{t}, y_{1:t} ) f( \alpha_{t} | y_{1:t} ) }{ f( \alpha_{t+1} | y_{1:t} ) } f( \alpha_{t+1} | y_{1:n} )  d \alpha_{t+1} } \quad (\because \ \textstyle 乗法定理) \\
            &amp;= f( \alpha_{t} | y_{1:t} ) \int { \frac{ f( \alpha_{t+1} | \alpha_{t}, y_{1:t} ) }{ f( \alpha_{t+1} | y_{1:t} ) } f( \alpha_{t+1} | y_{1:n} )  d \alpha_{t+1} } \\
            &amp;= f( \alpha_{t} | y_{1:t} ) \int { \frac{ f(\alpha_{t+1} | \alpha_{t}) }{ f(\alpha_{t+1} | y_{1:t}) } f(\alpha_{t+1} | y_{1:n}) d\alpha_{t+1} }. \quad (\because \ \textstyle 状態のマルコフ性) 
    \end{align*}
\end{split}\]</div>
</section>
</section>
</section>
<section id="id13">
<h2>3. 線形ガウス状態空間モデル (動的線形モデル)<a class="headerlink" href="#id13" title="Permalink to this headline">#</a></h2>
<section id="id14">
<h3>3.1 定義 (線形ガウス状態空間モデルの一般式)<a class="headerlink" href="#id14" title="Permalink to this headline">#</a></h3>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        線形ガウス状態空間モデルの一般式
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p>時系列ベクトル <span class="math notranslate nohighlight">\(y_t \ (t = 1, \dots, n)\)</span> について<strong>線形ガウス状態空間モデル</strong> (linear Gaussian state space model) は以下で表現できるモデルを指す.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        y_t &amp;= Z_t \alpha_t + \varepsilon_t, \ &amp;\varepsilon_t \sim N(0, H_t) \\
        \alpha_{t} &amp;= T_t \alpha_{t-1} + R_t \eta_t, \ &amp;\eta_t \sim N(0, Q_t)
    \end{align*}
\end{split}\]</div>
<p>ただし, <span class="math notranslate nohighlight">\(\alpha_0 \sim N(a_0, P_0)\)</span> である. 線形ガウス状態空間モデルは<strong>動的線形モデル</strong> (dynamic linear model) とも呼ぶ.</p>
</div>
<p>上記文字について</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Factor</p></th>
<th class="text-align:left head"><p>Dimensions</p></th>
<th class="head"><p>Explations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(y_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(p\)</span> 次元列ベクトル</p></td>
<td><p>観測値</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(Z_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(p \times m\)</span> 行列</p></td>
<td><p>デザイン行列</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(\alpha_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(m\)</span> 次元列ベクトル</p></td>
<td><p>状態変数ベクトル</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(T_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(m \times m\)</span> 行列</p></td>
<td><p>遷移行列</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(\varepsilon_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(p\)</span> 次元列ベクトル</p></td>
<td><p>観測値の誤差項</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(H_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(p \times p\)</span> 行列</p></td>
<td><p>観測値の分散共分散行列</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(\eta_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(r\)</span> 次元列ベクトル</p></td>
<td><p>状態方程式の誤差項</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(R_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(m \times r\)</span> 行列</p></td>
<td><p>選択行列</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(Q_t\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(r \times r\)</span> 行列</p></td>
<td><p>状態変数の分散共分散行列</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(a_0\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(p \)</span> 次元列ベクトル</p></td>
<td><p>状態変数の初期分布平均ベクトル</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><span class="math notranslate nohighlight">\(P_0\)</span></p></td>
<td class="text-align:left"><p><span class="math notranslate nohighlight">\(p \times p\)</span> 行列</p></td>
<td><p>状態減数の初期分布分散共分散行列</p></td>
</tr>
</tbody>
</table>
<p>であり, 誤差項と初期状態の組, <span class="math notranslate nohighlight">\(\varepsilon_t, \dots, \varepsilon_n, \eta_t, \dots, \eta_t, \alpha_1\)</span> は互いに独立と仮定され, <span class="math notranslate nohighlight">\(\varepsilon_t, \eta_t\)</span> は互いに独立であり, <span class="math notranslate nohighlight">\(\alpha_t, y_t\)</span> に対しても独立となる.</p>
</section>
<section id="id15">
<h3>3.2 例 (ローカルレベルモデル)<a class="headerlink" href="#id15" title="Permalink to this headline">#</a></h3>
<p>時系列 <span class="math notranslate nohighlight">\(\{y_1, \dots, y_t, \dots, y_n\}\)</span> について考える. 線形ガウス状態空間モデルにおいて</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        Z_t = [1], \quad \alpha_t = [\alpha_t], \quad \varepsilon_t = [\varepsilon_t], \quad H_t = [\sigma_\varepsilon^2], \\
        T_t = [1], \quad R_t = [1], \quad \eta_t = [\eta_t], \quad Q_t = [\sigma_\eta^2], \quad a_1 = [a_1], \quad P_1 = [P_1]
    \end{align*}
\end{split}\]</div>
<p>とした時</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        y_t &amp;= \alpha_t + \varepsilon_t, \ &amp;\varepsilon_t \sim N(0, \sigma_\varepsilon^2) \\
        \alpha_{t+1} &amp;= \alpha_t + \eta_t, \ &amp;\eta_t \sim N(0, \sigma_\eta^2) \\
    \end{align*}
\end{split}\]</div>
<p>ただし <span class="math notranslate nohighlight">\(\alpha_1 \sim N(a_1, P_1)\)</span> である. 上記で表現されるモデルを<strong>ローカルレベルモデル</strong> (local level model) という.<br/>
　ローカルレベルモデルに従う波形を python で再現してみる.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/warnings.html#module-warnings" title="warnings"><span class="nn">warnings</span></a>

<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.html#module-matplotlib.pyplot" title="matplotlib.pyplot"><span class="nn">matplotlib.pyplot</span></a> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="numpy"><span class="nn">numpy</span></a> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/warnings.html#warnings.filterwarnings" title="warnings.filterwarnings"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span></a><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>

<span class="c1"># プロット図の設定</span>
<a class="sphinx-codeautolink-a" href="https://seaborn.pydata.org/generated/seaborn.set.html#seaborn.set" title="seaborn.set"><span class="n">sns</span><span class="o">.</span><span class="n">set</span></a><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 擬似乱数生成のセットアップ</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

<span class="c1"># yt = Zt at + εt         εt ~ N(0, Ht)</span>
<span class="c1"># a{t+1} = Tt at + Rt ηt  ηt ~ N(0, Qt)</span>
<span class="c1"># 状態方程式の行列</span>
<span class="c1"># 誤差項の分散は既知とする</span>
<span class="n">Zt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">Tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">Rt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">Ht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">10</span><span class="p">]])</span>
<span class="n">Qt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]])</span>

<span class="c1"># サンプル数と状態変数の初期値</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>

<span class="c1"># 誤差項</span>
<span class="n">εt</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Ht</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>
<span class="n">ηt</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

<span class="c1"># シミュレーション的にローカルレベルモデルの状態と観測値を算出</span>
<span class="n">at</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>
<span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

<span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">a0</span> <span class="o">+</span> <span class="n">Rt</span> <span class="o">@</span> <span class="n">ηt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Zt</span> <span class="o">@</span> <span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">εt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">at</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">at</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">Rt</span> <span class="o">@</span> <span class="n">ηt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">yt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">Zt</span> <span class="o">@</span> <span class="n">at</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">εt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 観測値と状態変数の図示</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"observations"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"true state"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Local level model transition"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_18_0.png" src="../../_images/ssm_18_0.png"/>
</div>
</div>
</section>
</section>
<section id="id16">
<h2>4. カルマンフィルタ<a class="headerlink" href="#id16" title="Permalink to this headline">#</a></h2>
<p>時系列 <span class="math notranslate nohighlight">\(\{y_1, \dots, y_t, \dots, y_n \}\)</span> において以下の線形ガウス状態空間モデルで議論を進める. すなわち,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        y_t &amp;= Z_t \alpha_t + \varepsilon_t, \ &amp;\varepsilon_t \sim N(0, H_t) \\
        \alpha_{t} &amp;= T_t \alpha_{t-1} + R_t \eta_t, \ &amp;\eta_t \sim N(0, Q_t)
    \end{align*}
\end{split}\]</div>
<p>である. カルマンフィルタリング, カルマン平滑化, カルマン予測によってそれぞれ以下を求める.</p>
<ul class="simple">
<li><p><a class="reference internal" href="#tsa-ssm-kalman-filtering"><span class="std std-ref">カルマンフィルタリング</span></a></p>
<ul>
<li><p>フィルタリング分布 <span class="math notranslate nohighlight">\(N(a_{t|t}, P_{t|t})\)</span> :</p>
<ul>
<li><p>平均ベクトル <span class="math notranslate nohighlight">\(a_{t|t} = {\rm E}[\alpha_t | y_{1:t}]\)</span></p></li>
<li><p>共分散行列 <span class="math notranslate nohighlight">\(P_{t|t} = {\rm Var}[\alpha_t | y_{1:t}]\)</span></p></li>
</ul>
</li>
<li><p>1 期先予測分布 <span class="math notranslate nohighlight">\(N(a_t, P_t)\)</span> :</p>
<ul>
<li><p>平均ベクトル <span class="math notranslate nohighlight">\(a_t = {\rm E}[\alpha_t | y_{1:t-1}]\)</span></p></li>
<li><p>共分散行列 <span class="math notranslate nohighlight">\(P_t = {\rm Var}[\alpha_t | y_{1:t-1}]\)</span></p></li>
</ul>
</li>
<li><p>1 期先予測尤度 <span class="math notranslate nohighlight">\(N(f_t, F_t)\)</span> :</p>
<ul>
<li><p>平均値 <span class="math notranslate nohighlight">\(f_t = {\rm E}[y_t | y_{1:t-1}]\)</span></p></li>
<li><p>分散 <span class="math notranslate nohighlight">\(F_t = {\rm Var}[y_t | y_{1:t-1}]\)</span></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#tsa-ssm-kalman-forecasting"><span class="std std-ref">カルマン予測</span></a></p>
<ul>
<li><p><span class="math notranslate nohighlight">\(k\)</span> 期先予測分布 <span class="math notranslate nohighlight">\(N(a_{t+k}, P_{t+k})\)</span> :</p>
<ul>
<li><p>平均ベクトル <span class="math notranslate nohighlight">\(a_{t+k} = {\rm E}[\alpha_{t+k} | y_{1:t}]\)</span></p></li>
<li><p>共分散行列 <span class="math notranslate nohighlight">\(P_{t+k} = {\rm Var}[\alpha_{t+k} | y_{1:t}]\)</span></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#tsa-ssm-kalman-smoothing"><span class="std std-ref">カルマン平滑化</span></a></p>
<ul>
<li><p>平滑化分布 <span class="math notranslate nohighlight">\(N(s_t, S_t)\)</span> :</p>
<ul>
<li><p>平均ベクトル <span class="math notranslate nohighlight">\(s_{t} = {\rm E}[\alpha_{t} | y_{1:n}]\)</span></p></li>
<li><p>共分散行列 <span class="math notranslate nohighlight">\(S_{t} = {\rm Var}[\alpha_{t} | y_{1:n}]\)</span></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<section id="tsa-ssm-kalman-filtering">
<span id="id17"></span><h3>4.1 命題 (カルマンフィルタリング)<a class="headerlink" href="#tsa-ssm-kalman-filtering" title="Permalink to this headline">#</a></h3>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        カルマンフィルタリング
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><span class="math notranslate nohighlight">\(\alpha_{t-1} | y_{1:t-1} \sim N(a_{t-1|t-1}, P_{t-1|t-1})\)</span> が所与のときに, 以下の手順で逐次的に状態変数を更新することを<strong>カルマンフィルタリング</strong> (Kalman filtering) という.</p>
<p>(a) <span class="math notranslate nohighlight">\(y_{1:t-1}\)</span> が与えられた下での <span class="math notranslate nohighlight">\(\alpha_t\)</span> の 1 期先予測値 <span class="math notranslate nohighlight">\(a_t\)</span>, 1 期先予測誤差分散 <span class="math notranslate nohighlight">\(P_t\)</span> は以下で求める.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        a_{t} &amp;= T_{t} a_{t-1|t-1} \\
        P_{t} &amp;= T_{t} P_{t-1 | t-1} T_{t}' + R_{t} Q_{t} R_{t}'
    \end{align*}
\end{split}\]</div>
<p>(b) <span class="math notranslate nohighlight">\(y_{1:t-1}\)</span> が与えられた下での 1 期先予測尤度平均 <span class="math notranslate nohighlight">\(f_t\)</span>, 1 期先予測誤尤度分散 <span class="math notranslate nohighlight">\(F_t\)</span> は以下で求める.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f_{t} &amp;= Z_t a_t \\
        F_{t} &amp;= Z_t P_t Z_t' + H_t
    \end{align*}
\end{split}\]</div>
<p>(c) <span class="math notranslate nohighlight">\(y_{1:t}\)</span> が与えられた下でのフィルタリング平均 <span class="math notranslate nohighlight">\(a_{t|t}\)</span>, フィルタリング分散 <span class="math notranslate nohighlight">\(P_{t|t}\)</span> は以下で求める.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        a_{t|t} &amp;= a_t + K_t (y_t - f_t) \\
        P_{t|t} &amp;= P_t - K_t F_t K_t'
    \end{align*}
\end{split}\]</div>
<p>ただし, <span class="math notranslate nohighlight">\(K_t = P_t Z_t' F_t^{-1}\)</span> とし <strong>カルマンゲイン</strong> (Kalman gain) と呼ぶ.</p>
</div>
<p><u>証明</u></p>
<p>1 期先予測分布 <span class="math notranslate nohighlight">\(N(a_t, P_t)\)</span> について<a class="reference internal" href="../distribution/mdist.html#dist-mdist-marginal-conditional-total-exp-var"><span class="std std-ref">全期待値則</span></a>, <a class="reference internal" href="#tsa-ssm-definition-definition-markov"><span class="std std-ref">状態のマルコフ性</span></a> より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        a_{t} &amp;= {\rm E}(\alpha_{t} | y_{1:t-1}) \\
              &amp;= {\rm E}( {\rm E} ( \alpha_{t} | \alpha_{t-1}, y_{1:t-1} ) | y_{1:t-1}) \quad (\because \ 全期待値則) \\
              &amp;= {\rm E}( {\rm E} ( \alpha_{t} | \alpha_{t-1} ) | y_{1:t-1}) \quad (\because \ 状態のマルコフ性) \\
              &amp;= {\rm E}( T_{t} \alpha_{t-1} | y_{1:t-1}) \\
              &amp;= T_{t} a_{t-1|t-1}
    \end{align*}
\end{split}\]</div>
<p>分散については<a class="reference internal" href="../distribution/mdist.html#dist-mdist-marginal-conditional-total-exp-var"><span class="std std-ref">全分散則</span></a>, <a class="reference internal" href="#tsa-ssm-definition-definition-markov"><span class="std std-ref">状態のマルコフ性</span></a> より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        P_{t} &amp;= {\rm Var}(\alpha_{t} | y_{1:t-1}) \\
              &amp;= {\rm E}( {\rm Var} ( \alpha_{t} | \alpha_{t-1}, y_{1:t-1} ) | y_{1:t-1}) + {\rm Var}( {\rm E} ( \alpha_{t} | \alpha_{t-1}, y_{1:t-1} ) | y_{1:t-1}) \quad (\because \ 全分散則) \\
              &amp;= {\rm E}( {\rm Var} ( \alpha_{t} | \alpha_{t-1} ) | y_{1:t-1}) + {\rm Var}( {\rm E} ( \alpha_{t} | \alpha_{t-1} ) | y_{1:t-1}) \quad (\because \ 状態のマルコフ性) \\
              &amp;= {\rm E}( R{t} Q_{t-1} R'_{t} | y_{1:t-1}) + {\rm Var}( T_{t} \alpha_{t-1} | y_{1:t-1}) \\
              &amp;= R_{t} Q_{t} R_{t}' + T_{t} P_{t-1 | t-1} T_{t}'
    \end{align*}
\end{split}\]</div>
<p>と分かる. 1 期先予測尤度について <span class="math notranslate nohighlight">\(N(f_t, F_t)\)</span> も同様に計算して導出できる.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f_{t} &amp;= {\rm E}(y_{t} | y_{1:t-1}) \\
              &amp;= {\rm E}( {\rm E} ( y_{t} | \alpha_{t}, y_{1:t-1} ) | y_{1:t-1}) \quad (\because \ 全期待値則) \\
              &amp;= {\rm E}( {\rm E} ( y_{t} | \alpha_{t} ) | y_{1:t-1}) \quad (\because \ 状態空間モデルにおける条件付独立性) \\
              &amp;= {\rm E}( Z_{t} \alpha_{t} | y_{1:t-1}) \\
              &amp;= Z_{t} a_{t}
    \end{align*}
\end{split}\]</div>
<p>および</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        F_{t} &amp;= {\rm Var}(y_{t} | y_{1:t-1}) \\
              &amp;= {\rm E}( {\rm Var} ( y_{t} | \alpha_{t}, y_{1:t-1} ) | y_{1:t-1}) + {\rm Var}( {\rm E} ( y_{t} | \alpha_{t}, y_{1:t-1} ) | y_{1:t-1}) \quad (\because \ 全分散則) \\
              &amp;= {\rm E}( {\rm Var} ( y_{t} | \alpha_{t} ) | y_{1:t-1}) + {\rm Var}( {\rm E} ( y_{t} | \alpha_{t} ) | y_{1:t-1}) \quad (\because \ 状態空間モデルにおける条件付独立性) \\
              &amp;= {\rm E}( H_t | y_{1:t-1}) + {\rm Var}( Z_t \alpha_{t} | y_{1:t-1}) \\
              &amp;= H_{t} + Z_t P_t Z_t'.
    \end{align*}
\end{split}\]</div>
<p>最後にフィルタリング分布 <span class="math notranslate nohighlight">\(N(a_{t|t}, P_{t|t})\)</span> について<a class="reference internal" href="#tsa-ssm-recursive-filtering"><span class="std std-ref">一般の状態空間モデルの逐次求解におけるフィルタリング分布漸化式</span></a>から</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f(\alpha_t | y_{1:t}) 
            &amp;\propto f(y_t | \alpha_t) f(\alpha_t | y_{1:t-1}) \\
            &amp;\sim N(Z_t \alpha_t, H_t) N(a_t, P_t)
    \end{align*}
\end{split}\]</div>
<p>より<span class="xref myst">ベイズ線形回帰の事後分布における平均ベクトル, 分散行列</span>から <span class="math notranslate nohighlight">\(K_t = P_t Z_t' F_t^{-1}\)</span> として</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        a_{t|t} 
            &amp;= a_t + P_t Z_t' (Z_t P_t Z'_t + H_t)^{-1} (y_t - Z_t a_t) \\
            &amp;= a_t + P_t Z_t' F^{-1}_t (y_t - f_t) \\
            &amp;= a_t + K_t (y_t - f_t)
    \end{align*}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        P_{t|t} 
            &amp;= P_t + P_t Z_t' (Z_t P_t Z'_t + H_t)^{-1} Z_t P_t \\
            &amp;= P_t + P_t Z_t' F^{-1}_t F_t F^{-1}_t Z_t P_t \\
            &amp;= P_t + K_t F_t K_t'.
    \end{align*}
\end{split}\]</div>
</section>
<section id="python">
<h3>4.2 例 (python によるカルマンフィルタの実装)<a class="headerlink" href="#python" title="Permalink to this headline">#</a></h3>
<p>上記で求めた更新式をそのままコーディングするだけで実施可能なので技術的にはかなり容易.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kalman_filter</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Pt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">Zt</span><span class="p">,</span> <span class="n">Tt</span><span class="p">,</span> <span class="n">Rt</span><span class="p">,</span> <span class="n">Ht</span><span class="p">,</span> <span class="n">Qt</span><span class="p">):</span>
    <span class="sd">"""Kalman filter</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    at : </span>
<span class="sd">    Pt :</span>
<span class="sd">    yt :</span>
<span class="sd">    Zt :</span>
<span class="sd">    Rt :</span>
<span class="sd">    Ht :</span>
<span class="sd">    Qt :</span>
<span class="sd">    </span>
<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    at1 : </span>
<span class="sd">    Pt1 :</span>
<span class="sd">    </span>
<span class="sd">    """</span>
    <span class="c1"># (a) one-step ahead predictor of a_t, P_t</span>
    <span class="n">a_ahead</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">at</span>
    <span class="n">P_ahead</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">Pt</span> <span class="o">@</span> <span class="n">Tt</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Rt</span> <span class="o">@</span> <span class="n">Qt</span> <span class="o">@</span> <span class="n">Rt</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># (b) one-step predictor on the error for y_t</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">Zt</span> <span class="o">@</span> <span class="n">a_ahead</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">Zt</span> <span class="o">@</span> <span class="n">P_ahead</span> <span class="o">@</span> <span class="n">Zt</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Ht</span>

    <span class="c1"># Kalman gain</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">P_ahead</span> <span class="o">@</span> <span class="n">Zt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

    <span class="c1"># (c) filtered a_{t+1}, P_{t+1}</span>
    <span class="n">a_next</span> <span class="o">=</span> <span class="n">a_ahead</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="p">(</span><span class="n">yt</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">P_next</span> <span class="o">=</span> <span class="n">P_ahead</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">F</span> <span class="o">@</span> <span class="n">K</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">a_next</span><span class="p">,</span> <span class="n">P_next</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
<span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e7</span><span class="p">])</span>

<span class="n">a_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">P_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">P_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">kalman_filter</span><span class="p">(</span>
            <span class="n">a0</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">yt</span><span class="o">=</span><span class="n">yt</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Zt</span><span class="o">=</span><span class="n">Zt</span><span class="p">,</span> <span class="n">Tt</span><span class="o">=</span><span class="n">Tt</span><span class="p">,</span> <span class="n">Rt</span><span class="o">=</span><span class="n">Rt</span><span class="p">,</span> <span class="n">Ht</span><span class="o">=</span><span class="n">Ht</span><span class="p">,</span> <span class="n">Qt</span><span class="o">=</span><span class="n">Qt</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">P_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">kalman_filter</span><span class="p">(</span>
            <span class="n">a_filtered</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">t</span><span class="p">],</span>
            <span class="n">P_filtered</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">t</span><span class="p">],</span>
            <span class="n">yt</span><span class="o">=</span><span class="n">yt</span><span class="p">[</span><span class="n">t</span> <span class="p">:</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">Zt</span><span class="o">=</span><span class="n">Zt</span><span class="p">,</span>
            <span class="n">Tt</span><span class="o">=</span><span class="n">Tt</span><span class="p">,</span>
            <span class="n">Rt</span><span class="o">=</span><span class="n">Rt</span><span class="p">,</span>
            <span class="n">Ht</span><span class="o">=</span><span class="n">Ht</span><span class="p">,</span>
            <span class="n">Qt</span><span class="o">=</span><span class="n">Qt</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 観測値と状態変数の図示</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"observations"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"true state"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a_filtered</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"filtered state"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Local level model transition"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_24_0.png" src="../../_images/ssm_24_0.png"/>
</div>
</div>
</section>
<section id="tsa-ssm-kalman-forecasting">
<span id="id18"></span><h3>4.3 命題 (カルマン予測)<a class="headerlink" href="#tsa-ssm-kalman-forecasting" title="Permalink to this headline">#</a></h3>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        カルマン予測
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><span class="math notranslate nohighlight">\(k-1\)</span> 期先予測分布 <span class="math notranslate nohighlight">\(N(a_{t+k-1}, P_{t+k-1})\)</span> が所与のときに, 以下の手順で逐次的に状態変数を更新することを<strong>カルマン予測</strong> (Kalman forecasting) という.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        a_{t+k} &amp;= T_{t+k} a_{t+k-1} \\
        P_{t+k} &amp;= R_{t+k} Q_{t+k} R_{t+k}' + T_{t+k} P_{t+k-1} T_{t+k}'
    \end{align*}
\end{split}\]</div>
</div>
<p><u>証明</u></p>
<p><span class="math notranslate nohighlight">\(k\)</span> 期先予測分布 <span class="math notranslate nohighlight">\(N(a_{t+k}, P_{t+k})\)</span> について<a class="reference internal" href="../distribution/mdist.html#dist-mdist-marginal-conditional-total-exp-var"><span class="std std-ref">全期待値則</span></a>, <a class="reference internal" href="#tsa-ssm-definition-definition-markov"><span class="std std-ref">状態のマルコフ性</span></a> より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        a_{t+k} 
            &amp;= {\rm E}(\alpha_{t+k} | y_{1:t}) \\
            &amp;= {\rm E}( {\rm E} ( \alpha_{t+k} | \alpha_{t+k-1}, y_{1:t} ) | y_{1:t}) \quad (\because \ 全期待値則) \\
            &amp;= {\rm E}( {\rm E} ( \alpha_{t+k} | \alpha_{t+k-1} ) | y_{1:t}) \quad (\because \ 状態のマルコフ性) \\
            &amp;= {\rm E}( T_{t+k} \alpha_{t+k-1} | y_{1:t}) \\
            &amp;= T_{t+k} a_{t+k-1}
    \end{align*}
\end{split}\]</div>
<p>分散については<a class="reference internal" href="../distribution/mdist.html#dist-mdist-marginal-conditional-total-exp-var"><span class="std std-ref">全分散則</span></a>, <a class="reference internal" href="#tsa-ssm-definition-definition-markov"><span class="std std-ref">状態のマルコフ性</span></a> より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        P_{t+k} 
            &amp;= {\rm Var}(\alpha_{t+k} | y_{1:t}) \\
            &amp;= {\rm E}( {\rm Var} ( \alpha_{t+k} | \alpha_{t+k-1}, y_{1:t} ) | y_{1:t}) + {\rm Var}( {\rm E} ( \alpha_{t+k} | \alpha_{t+k-1}, y_{1:t} ) | y_{1:t}) \quad (\because \ 全分散則) \\
            &amp;= {\rm E}( {\rm Var} ( \alpha_{t+k} | \alpha_{t+k-1} ) | y_{1:t}) + {\rm Var}( {\rm E} ( \alpha_{t+k} | \alpha_{t+k-1} ) | y_{1:t}) \quad (\because \ 状態のマルコフ性) \\
            &amp;= {\rm E}( R{t+k} Q_{t+k-1} R'_{t+k} | y_{1:t}) + {\rm Var}( T_{t+k} \alpha_{t+k-1} | y_{1:t}) \\
            &amp;= R_{t+k} Q_{t+k} R_{t+k}' + T_{t+k} P_{t+k-1} T_{t+k}'.
    \end{align*}
\end{split}\]</div>
</section>
<section id="id19">
<h3>4.4 例 (python によるカルマン予測の実装)<a class="headerlink" href="#id19" title="Permalink to this headline">#</a></h3>
<p>上記で求めた更新式を実装する.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kalman_forecastor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Tt</span><span class="p">,</span> <span class="n">Rt</span><span class="p">,</span> <span class="n">Qt</span><span class="p">):</span>
    <span class="n">a_ahead</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">a</span>
    <span class="n">P_ahead</span> <span class="o">=</span> <span class="n">Rt</span> <span class="o">@</span> <span class="n">Qt</span> <span class="o">@</span> <span class="n">Rt</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Tt</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">a_ahead</span><span class="p">,</span> <span class="n">P_ahead</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">P_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">a_filtered</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">P_filtered</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">]</span> <span class="o">@</span> <span class="n">Tt</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Rt</span> <span class="o">@</span> <span class="n">Qt</span> <span class="o">@</span> <span class="n">Rt</span><span class="o">.</span><span class="n">T</span>
        <span class="n">a_pred</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">P_pred</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_pred</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">P_pred</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">kalman_forecastor</span><span class="p">(</span>
            <span class="n">a_pred</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">P_pred</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Tt</span><span class="o">=</span><span class="n">Tt</span><span class="p">,</span> <span class="n">Rt</span><span class="o">=</span><span class="n">Rt</span><span class="p">,</span> <span class="n">Qt</span><span class="o">=</span><span class="n">Qt</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 観測値と状態変数の図示</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"observations"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"true state"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a_filtered</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"filtered state"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">),</span> <span class="n">a_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"forecasted state"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Local level model transition"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_29_0.png" src="../../_images/ssm_29_0.png"/>
</div>
</div>
</section>
<section id="tsa-ssm-kalman-smoothing">
<span id="id20"></span><h3>4.5 命題 (カルマン平滑化)<a class="headerlink" href="#tsa-ssm-kalman-smoothing" title="Permalink to this headline">#</a></h3>
<div style="background: rgb(0, 0, 0); border: 1px solid rgb(0, 0, 0); padding-left: 20px;">
<span style="color: white; font-size: 100%;">
        カルマン平滑化
    </span>
</div>
<div style="border: rgb(0, 0, 0) solid 1px; font-size: 100%; padding: 10px 10px 0 10px; margin-bottom: 10px;">
<p><span class="math notranslate nohighlight">\(t+1\)</span> 期先予測分布 <span class="math notranslate nohighlight">\(N(s_{t+1}, S_{t+1})\)</span> が所与のときに, 以下の手順で逐次的に状態変数を更新することを<strong>カルマン平滑化</strong> (Kalman smoothing) という.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        s_{t} &amp;= a_{t|t} + A_{t} (s_{t+1} - a_{t+1}) \\
        S_{t} &amp;= P_{t|t} + A_t (S_{t+1} - P_{t+1}) A_t'
    \end{align*}
\end{split}\]</div>
<p>ただし, <span class="math notranslate nohighlight">\(A_t = P_{t|t}T_{t+1}'P_{t+1}^{-1}\)</span> とし<strong>平滑化利得</strong> (smoothing gain) と呼ぶ.</p>
</div>
<p><u>証明</u></p>
<p>平滑化分布 <span class="math notranslate nohighlight">\(N(s_{t}, S_{t})\)</span> について<a class="reference internal" href="../distribution/mdist.html#dist-mdist-marginal-conditional-total-exp-var"><span class="std std-ref">全期待値則</span></a>, <a class="reference internal" href="#tsa-ssm-definition-definition-cond-independent"><span class="std std-ref">状態空間モデルの条件付独立性</span></a> より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        s_{t} 
            &amp;= {\rm E}(\alpha_{t} | y_{1:n}) \\
            &amp;= {\rm E}( {\rm E} ( \alpha_{t} | \alpha_{t+1}, y_{1:n} ) | y_{1:n}) \quad (\because \ 全期待値則) \\
            &amp;= {\rm E}( {\rm E} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} ) | y_{1:n}) \quad (\because \ 条件付独立性)
    \end{align*}
\end{split}\]</div>
<p>となる. ここで <span class="math notranslate nohighlight">\(\alpha_{t} | \alpha_{t+1}, y_{1:t}\)</span> の分布を考えると, <a class="reference internal" href="../distribution/mdist.html#conditional-distribution"><span class="std std-ref">乗法定理</span></a>, <a class="reference internal" href="#tsa-ssm-definition-definition-markov"><span class="std std-ref">状態のマルコフ連鎖性</span></a> から</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        f(\alpha_{t} | \alpha_{t+1}, y_{1:t})
            &amp;= \frac{ f(\alpha_{t}, \alpha_{t+1} | y_{1:t}) }{ f(\alpha_{t+1} | y_{1:t}) } \quad (\because \ 乗法定理) \\
            &amp;\propto f(\alpha_{t}, \alpha_{t+1} | y_{1:t}) \\
            &amp;= f(\alpha_{t+1} | \alpha_{t}, y_{1:t} ) f(\alpha_{t} | y_{1:t}) \quad (\because \ 乗法定理) \\
            &amp;= f(\alpha_{t+1} | \alpha_{t} ) f(\alpha_{t} | y_{1:t}) \quad (\because \ 状態のマルコフ性) \\
            &amp;\sim N(T_{t+1} \alpha_{t}, R_{t+1}Q_{t+1}R_{t+1}' ) N(a_{t|t}, P_{t|t})
    \end{align*}
\end{split}\]</div>
<p>となるので<span class="xref myst">ベイズ線形回帰の事後分布における平均ベクトル, 分散行列</span>から <span class="math notranslate nohighlight">\(A_t = P_{t+1} T_{t+1}' P_{t+1}^{-1}\)</span> として</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        {\rm E} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} )
            &amp;= a_{t|t} + P_{t|t} T_{t+1}' (T_{t+1} P_{t|t} T_{t+1}' + R_{t+1}Q_{t+1}R_{t+1}' )^{-1}(\alpha_{t+1} - T_{t+1} a_{t|t} ) \\
            &amp;= a_{t|t} + P_{t|t} T_{t+1}' P_{t+1}^{-1}(\alpha_{t+1} - T_{t+1} a_{t|t} ) \\
            &amp;= a_{t|t} + A_{t} (\alpha_{t+1} - T_{t+1} a_{t|t} )
    \end{align*}
\end{split}\]</div>
<p>ゆえに</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        s_{t}
            &amp;= {\rm E}( {\rm E} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} ) | y_{1:n}) \\
            &amp;= {\rm E}( a_{t|t} + A_{t} (\alpha_{t+1} - T_{t+1} a_{t|t} ) | y_{1:n}) \\
            &amp;= a_{t|t} + A_{t} (s_{t+1} - a_{t+1} ).
    \end{align*}
\end{split}\]</div>
<p>また <span class="math notranslate nohighlight">\(S_t\)</span> について</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        S_{t} 
            &amp;= {\rm Var}(\alpha_{t} | y_{1:n}) \\
            &amp;= {\rm E}( {\rm Var} ( \alpha_{t} | \alpha_{t+1}, y_{1:n} ) | y_{1:n}) + {\rm Var}( {\rm E} ( \alpha_{t} | \alpha_{t+1}, y_{1:n} ) | y_{1:n}) \quad (\because \ 全分散則) \\
            &amp;= {\rm E}( {\rm Var} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} ) | y_{1:n}) + {\rm Var}( {\rm E} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} ) | y_{1:n}) \quad (\because \ 条件付独立性)
    \end{align*}
\end{split}\]</div>
<p><span class="math notranslate nohighlight">\({\rm Var} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} )\)</span> について <span class="math notranslate nohighlight">\(s_t\)</span> で行った分布の議論より</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        {\rm Var} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} )
            &amp;= P_{t|t} + P_{t|t} T_{t+1}' (T_{t+1} P_{t|t} T_{t+1}' + R_{t+1}Q_{t+1}R_{t+1}' )^{-1} T_{t+1} P_{t|t}' \\
            &amp;= P_{t|t} + P_{t|t} T_{t+1}' P_{t+1}^{-1} T_{t+1} P_{t|t}' \\
            &amp;= P_{t|t} + A_t P_{t+1} A_t'
    \end{align*}
\end{split}\]</div>
<p>となるので</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align*}
        S_{t} 
            &amp;= {\rm E}( {\rm Var} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} ) | y_{1:n}) + {\rm Var}( {\rm E} ( \alpha_{t} | \alpha_{t+1}, y_{1:t} ) | y_{1:n}) \\
            &amp;= {\rm E}( P_{t|t} + A_t P_{t+1} A_t' | y_{1:n}) + {\rm Var}( a_{t|t} + A_{t} (\alpha_{t+1} - T_{t+1} a_{t|t} ) | y_{1:n}) \\
            &amp;= P_{t|t} - A_t P_{t+1} A_t' + A_t S_{t+1} A_t' \\
            &amp;= P_{t|t} + A_t (S_{t+1} - P_{t+1}) A_t'.
    \end{align*}
\end{split}\]</div>
</section>
<section id="id21">
<h3>4.6 例 (python によるカルマン平滑化の実装)<a class="headerlink" href="#id21" title="Permalink to this headline">#</a></h3>
<p>上記で求めた更新式を実装する.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kalman_smoother</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">Pt</span><span class="p">,</span> <span class="n">Tt</span><span class="p">,</span> <span class="n">Rt</span><span class="p">,</span> <span class="n">Qt</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">at</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Rt</span> <span class="o">@</span> <span class="n">Qt</span> <span class="o">@</span> <span class="n">Rt</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Tt</span> <span class="o">@</span> <span class="n">Pt</span> <span class="o">@</span> <span class="n">Tt</span><span class="o">.</span><span class="n">T</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">Pt</span> <span class="o">@</span> <span class="n">Tt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

    <span class="n">s_back</span> <span class="o">=</span> <span class="n">at</span> <span class="o">+</span> <span class="n">A</span> <span class="o">@</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">S_back</span> <span class="o">=</span> <span class="n">Pt</span> <span class="o">+</span> <span class="n">A</span> <span class="o">@</span> <span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">P</span><span class="p">)</span> <span class="o">@</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">s_back</span><span class="p">,</span> <span class="n">S_back</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">S</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">kalman_smoother</span><span class="p">(</span>
            <span class="n">s</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">a_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">P_filtered</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">Tt</span><span class="o">=</span><span class="n">Tt</span><span class="p">,</span> <span class="n">Rt</span><span class="o">=</span><span class="n">Rt</span><span class="p">,</span> <span class="n">Qt</span><span class="o">=</span><span class="n">Qt</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 観測値と状態変数の図示</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"observations"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"true state"</span><span class="p">)</span>
<span class="c1"># ax.plot(a_filtered, color="red", label="filtered state")</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"smoothed state"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Local level model transition"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_34_0.png" src="../../_images/ssm_34_0.png"/>
</div>
</div>
</section>
</section>
<section id="statsmodels">
<h2>5. statsmodels による状態空間モデル<a class="headerlink" href="#statsmodels" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> モジュールではカルマンフィルターを用いた状態空間モデルを構築するのに有用なクラス・メソッドが用意されている.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.structural.UnobservedComponents.html"><code class="docutils literal notranslate"><span class="pre">statsmodels.tsa.statespace.structural.UnobservedComponents</span></code></a></p>
<ul>
<li><p>動的線形モデルを構築するにあたって必要な機能がまとめられたモジュール.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.mlemodel.MLEModel.html#statsmodels.tsa.statespace.mlemodel.MLEModel"><code class="docutils literal notranslate"><span class="pre">statsmodels.tsa.statespace.mlemodel.MLEModel</span></code></a></p>
<ul>
<li><p>カルマンフィルターを用いた状態空間モデルをカスタムで作成する際に用いるモジュール.</p></li>
</ul>
</li>
</ul>
<section id="unobservedcomponents">
<h3>5.1 例 (UnobservedComponentsによる状態空間モデル構築)<a class="headerlink" href="#unobservedcomponents" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.structural.UnobservedComponents.html?highlight=statsmodels.tsa.statespace.structural.UnobservedComponents">APIドキュメント</a></p></li>
</ul>
<p>トレンド, 季節要因, 回帰成分に関するシミュレーションデータを構築するクラスを以下のように定義し, これを用いてテストデータを作成した上で, <code class="docutils literal notranslate"><span class="pre">statsmodels.tsa.statespace.structural.UnobservedComponents</span></code> の使い方を確認する.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <a class="sphinx-codeautolink-a" href="../../api/sandbox/datamodel/ts_simulator/index.html#module-sandbox.datamodel.ts_simulator" title="sandbox.datamodel.ts_simulator"><span class="nn">sandbox.datamodel.ts_simulator</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../../api/sandbox/datamodel/ts_simulator/index.html#sandbox.datamodel.ts_simulator.UnobservedComponentsSimulator" title="sandbox.datamodel.ts_simulator.UnobservedComponentsSimulator"><span class="n">UnobservedComponentsSimulator</span></a>

<span class="n">sim</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../../api/sandbox/datamodel/ts_simulator/index.html#sandbox.datamodel.ts_simulator.UnobservedComponentsSimulator" title="sandbox.datamodel.ts_simulator.UnobservedComponentsSimulator"><span class="n">UnobservedComponentsSimulator</span></a><span class="p">(</span>
    <span class="n">steps</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">trend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">freq_seasonal</span><span class="o">=</span><span class="p">[{</span><span class="s2">"period"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">"harmonics"</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="s2">"period"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">"harmonics"</span><span class="p">:</span> <span class="mi">6</span><span class="p">}],</span>
    <span class="n">exog_params</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,],</span>
    <span class="n">start_param_level</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">stddev_level</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">stddev_trend</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">stddev_freq_seasonal</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">ret</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../../api/sandbox/datamodel/ts_simulator/index.html#sandbox.datamodel.ts_simulator.UnobservedComponentsSimulator.simulate" title="sandbox.datamodel.ts_simulator.UnobservedComponentsSimulator.simulate"><span class="n">sim</span><span class="o">.</span><span class="n">simulate</span></a><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span><span class="o">.</span><span class="n">convert_pandas</span><span class="p">()</span>

<span class="c1"># 観測値, 状態変数 (ローカル・トレンド) のプロット.</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># 観測値</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">411</span><span class="p">)</span>
<span class="n">ret</span><span class="o">.</span><span class="n">endog</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated observations"</span><span class="p">)</span>

<span class="c1"># トレンド</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">412</span><span class="p">)</span>
<span class="n">ret</span><span class="o">.</span><span class="n">trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Trend"</span><span class="p">)</span>

<span class="c1"># シーズン性</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">413</span><span class="p">)</span>
<span class="n">ret</span><span class="o">.</span><span class="n">freq_seasonal</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Seasonality"</span><span class="p">)</span>

<span class="c1"># 回帰成分</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">414</span><span class="p">)</span>
<span class="n">ret</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Regression"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_38_0.png" src="../../_images/ssm_38_0.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/warnings.html#module-warnings" title="warnings"><span class="nn">warnings</span></a>

<span class="kn">from</span> <span class="nn">statsmodels.tsa.statespace.structural</span> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.structural.UnobservedComponents.html#statsmodels.tsa.statespace.structural.UnobservedComponents" title="statsmodels.tsa.statespace.structural.UnobservedComponents"><span class="n">UnobservedComponents</span></a>

<a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/warnings.html#warnings.simplefilter" title="warnings.simplefilter"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span></a><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>

<span class="n">ret</span><span class="o">.</span><span class="n">convert_ndarray</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.structural.UnobservedComponents.html#statsmodels.tsa.statespace.structural.UnobservedComponents" title="statsmodels.tsa.statespace.structural.UnobservedComponents"><span class="n">UnobservedComponents</span></a><span class="p">(</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">trend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">freq_seasonal</span><span class="o">=</span><span class="p">[{</span><span class="s2">"period"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">"harmonics"</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="s2">"period"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">"harmonics"</span><span class="p">:</span> <span class="mi">6</span><span class="p">}],</span>
    <span class="n">exog</span><span class="o">=</span><span class="n">ret</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span>
    <span class="n">stochastic_level</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">stochastic_trend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">stochastic_freq_seasonal</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">ret_ssm</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.structural.UnobservedComponents.fit.html#statsmodels.tsa.statespace.structural.UnobservedComponents.fit" title="statsmodels.tsa.statespace.structural.UnobservedComponents.fit"><span class="n">model</span><span class="o">.</span><span class="n">fit</span></a><span class="p">()</span>
<span class="n">ret_ssm</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> This problem is unconstrained.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RUNNING THE L-BFGS-B CODE

           * * *

Machine precision = 2.220D-16
 N =            5     M =           10

At X0         0 variables are exactly at the bounds

At iterate    0    f=  3.39664D+00    |proj g|=  1.56735D-01

At iterate    5    f=  1.01591D+00    |proj g|=  1.44373D+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>At iterate   10    f=  2.62900D-01    |proj g|=  2.00037D+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>At iterate   15    f= -7.45997D-01    |proj g|=  1.81921D+01

At iterate   20    f= -1.38754D+00    |proj g|=  1.68847D+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>At iterate   25    f= -1.39574D+00    |proj g|=  2.57964D+00

At iterate   30    f= -1.39690D+00    |proj g|=  2.45095D+00

At iterate   35    f= -1.39705D+00    |proj g|=  1.50381D-03
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>At iterate   40    f= -1.39705D+00    |proj g|=  4.79069D-02

           * * *

Tit   = total number of iterations
Tnf   = total number of function evaluations
Tnint = total number of segments explored during Cauchy searches
Skip  = number of BFGS updates skipped
Nact  = number of active bounds at final generalized Cauchy point
Projg = norm of the final projected gradient
F     = final function value

           * * *

   N    Tit     Tnf  Tnint  Skip  Nact     Projg        F
    5     40    103      1     0     0   4.791D-02  -1.397D+00
  F =  -1.3970515694210084     

CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH             
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> Warning:  more than 10 function and gradient
   evaluations in the last line search.  Termination
   may possibly be caused by a bad search direction.
</pre></div>
</div>
<div class="output text_html"><table class="simpletable">
<caption>Unobserved Components Results</caption>
<tr>
<th>Dep. Variable:</th> <td>y</td> <th>  No. Observations:  </th> <td>300</td>
</tr>
<tr>
<th>Model:</th> <td>None</td> <th>  Log Likelihood     </th> <td>419.115</td>
</tr>
<tr>
<th></th> <td>+ stochastic freq_seasonal(50(4))</td> <th>  AIC                </th> <td>-828.231</td>
</tr>
<tr>
<th></th> <td>+ stochastic freq_seasonal(100(6))</td> <th>  BIC                </th> <td>-810.093</td>
</tr>
<tr>
<th>Date:</th> <td>Tue, 02 Aug 2022</td> <th>  HQIC               </th> <td>-820.954</td>
</tr>
<tr>
<th>Time:</th> <td>15:19:37</td> <th> </th> <td> </td>
</tr>
<tr>
<th>Sample:</th> <td>0</td> <th> </th> <td> </td>
</tr>
<tr>
<th></th> <td> - 300</td> <th> </th> <td> </td>
</tr>
<tr>
<th>Covariance Type:</th> <td>opg</td> <th> </th> <td> </td>
</tr>
</table>
<table class="simpletable">
<tr>
<td></td> <th>coef</th> <th>std err</th> <th>z</th> <th>P&gt;|z|</th> <th>[0.025</th> <th>0.975]</th>
</tr>
<tr>
<th>sigma2.level</th> <td> 3.159e-10</td> <td>    0.000</td> <td> 1.44e-06</td> <td> 1.000</td> <td>   -0.000</td> <td>    0.000</td>
</tr>
<tr>
<th>sigma2.trend</th> <td> 2.401e-11</td> <td> 2.91e-08</td> <td>    0.001</td> <td> 0.999</td> <td> -5.7e-08</td> <td>  5.7e-08</td>
</tr>
<tr>
<th>sigma2.freq_seasonal_50(4)</th> <td> 8.387e-05</td> <td> 3.79e-05</td> <td>    2.214</td> <td> 0.027</td> <td> 9.61e-06</td> <td>    0.000</td>
</tr>
<tr>
<th>sigma2.freq_seasonal_100(6)</th> <td> 9.713e-05</td> <td> 3.99e-05</td> <td>    2.432</td> <td> 0.015</td> <td> 1.88e-05</td> <td>    0.000</td>
</tr>
<tr>
<th>beta.x1</th> <td>    4.9979</td> <td>    0.003</td> <td> 1704.902</td> <td> 0.000</td> <td>    4.992</td> <td>    5.004</td>
</tr>
</table>
<table class="simpletable">
<tr>
<th>Ljung-Box (L1) (Q):</th> <td>1.21</td> <th>  Jarque-Bera (JB):  </th> <td>0.34</td>
</tr>
<tr>
<th>Prob(Q):</th> <td>0.27</td> <th>  Prob(JB):          </th> <td>0.84</td>
</tr>
<tr>
<th>Heteroskedasticity (H):</th> <td>1.17</td> <th>  Skew:              </th> <td>0.02</td>
</tr>
<tr>
<th>Prob(H) (two-sided):</th> <td>0.46</td> <th>  Kurtosis:          </th> <td>2.83</td>
</tr>
</table><br/><br/>Warnings:<br/>[1] Covariance matrix calculated using the outer product of gradients (complex-step).</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">common_index</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Observations"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ret_ssm</span><span class="o">.</span><span class="n">fittedvalues</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Smoothing values"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"State Space Models using UnobservedComponents"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_40_0.png" src="../../_images/ssm_40_0.png"/>
</div>
</div>
</section>
<section id="mlemodel-mlemodel">
<h3>5.2 例 (MLEModelでのカスタム構築: MLEModel の基本説明)<a class="headerlink" href="#mlemodel-mlemodel" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> で任意の線形ガウス状態空間モデルを構築するクラスとして <a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.mlemodel.MLEModel.html"><code class="docutils literal notranslate"><span class="pre">statsmodels.tsa.statespace.mlemodel.MLEModel</span></code></a> があるが, 以下の状態空間モデル一般式を想定している.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    y_t &amp;= Z_t + \alpha_t + d_t + \varepsilon_t \quad &amp;\varepsilon_t \sim N(0, H_t) \\
    \alpha_t &amp;= T_t \alpha_{t-1} + c_t + R_t \eta_t \quad &amp;\eta_t \sim N(0, Q_t) 
\end{align*}
\end{split}\]</div>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>数式</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">MLEModels</span></code> における表現</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">MLEModels</span></code> における次元表現</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p><span class="math notranslate nohighlight">\(Z_t\)</span></p></td>
<td><p>design</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">k_endog</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">k_states</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">nobs</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p><span class="math notranslate nohighlight">\(d_t\)</span></p></td>
<td><p>obs_intercept</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">k_endog</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">nobs</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p><span class="math notranslate nohighlight">\(H_t\)</span></p></td>
<td><p>obs_cov</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">k_endog</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">k_endog</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">nobs</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p><span class="math notranslate nohighlight">\(T_t\)</span></p></td>
<td><p>transition</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">k_states</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">k_states</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">nobs</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p><span class="math notranslate nohighlight">\(c_t\)</span></p></td>
<td><p>state_intercept</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">k_states</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">nobs</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p><span class="math notranslate nohighlight">\(R_t\)</span></p></td>
<td><p>selection</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">k_states</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">k_posdef</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">nobs</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p><span class="math notranslate nohighlight">\(Q_t\)</span></p></td>
<td><p>state_cov</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">k_posdef</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">k_posdef</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">nobs</span></code></p></td>
</tr>
</tbody>
</table>
<p>カスタムで構築する際には以下をコーディングする必要がある. 具体例は以下で作成しているモデルプログラムを参照のこと.<br/>
　以下の説明は<a class="reference external" href="https://www.statsmodels.org/stable/examples/notebooks/generated/statespace_local_linear_trend.html">公式ドキュメント</a>にも記載.</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">k_states</span></code>, <code class="docutils literal notranslate"><span class="pre">k_posdef</span></code> の設定:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code> の中で定義し, それぞれ状態変数の数, 状態変数の未知分散パラメータ数を指す.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">update</span></code> メソッドの定義:</p>
<ul class="simple">
<li><p>XXXX</p></li>
</ul>
</li>
<li><p>statespace matrices ( <code class="docutils literal notranslate"><span class="pre">ssm</span></code> ) の指定:</p>
<ul class="simple">
<li><p>XXXX</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">start</span> <span class="pre">params</span></code> メソッドの定義:</p>
<ul class="simple">
<li><p>XXXX</p></li>
</ul>
</li>
<li><p>initialization 系メソッドの定義:</p>
<ul class="simple">
<li><p>XXXX</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">transform_params</span></code> / <code class="docutils literal notranslate"><span class="pre">transform_params</span></code> メソッドの設定:</p>
<ul class="simple">
<li><p>XXXX</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">param_names</span></code> メソッドの定義:</p>
<ul class="simple">
<li><p>XXXX</p></li>
</ul>
</li>
</ol>
</section>
<section id="mlemodel">
<h3>5.3 例 (MLEModelでのカスタム構築: ローカル線形トレンドモデル)<a class="headerlink" href="#mlemodel" title="Permalink to this headline">#</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    y_t &amp;= 
        \begin{bmatrix}
            1 &amp; 0
        \end{bmatrix}
        \begin{bmatrix}
            \mu_t \\
            \nu_t
        \end{bmatrix} + \varepsilon_t \quad \varepsilon_t \sim N(0, \sigma_\varepsilon^2) \\
    \begin{bmatrix}
        \mu_t \\
        \nu_t
    \end{bmatrix} &amp;=
        \begin{bmatrix}
            1 &amp; 1 \\
            0 &amp; 1
        \end{bmatrix}
        \begin{bmatrix}
            \mu_{t-1} \\
            \nu_{t-1}
        \end{bmatrix} +
        \begin{bmatrix}
            1 &amp; 0 \\
            0 &amp; 1
        \end{bmatrix}
        \begin{bmatrix}
            \xi_t \\
            \zeta_t
        \end{bmatrix} \quad
        \begin{bmatrix}
            \xi_t \\
            \zeta_t
        \end{bmatrix} \sim
        N \biggl( 
            \begin{bmatrix}
                0 \\
                0
            \end{bmatrix},
            \begin{bmatrix}
                \sigma_\xi^2 &amp; 0 \\
                0            &amp; \sigma_\zeta^2
            \end{bmatrix}
        \biggr)
\end{align*}
\end{split}\]</div>
<p>より</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">k_states</span></code>, <code class="docutils literal notranslate"><span class="pre">k_posdef</span></code> は 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssm["design"]</span></code> <span class="math notranslate nohighlight">\( = Z_t = \begin{bmatrix} 1 &amp; 0 \end{bmatrix}\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssm["transition"]</span></code> <span class="math notranslate nohighlight">\( = T_t = \begin{bmatrix} 1 &amp; 1 \\ 0 &amp; 1 \end{bmatrix}\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssm["selection"]</span></code> <span class="math notranslate nohighlight">\( = R_t = \begin{bmatrix} 1 &amp; 0 \\ 0 &amp; 1 \end{bmatrix}\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code> <span class="math notranslate nohighlight">\(=\begin{bmatrix} \sigma_\varepsilon^2 &amp; \sigma_\xi^2 &amp; \sigma_\zeta^2 \end{bmatrix}\)</span></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <a class="sphinx-codeautolink-a" href="../../api/sandbox/datasets/index.html#module-sandbox.datasets" title="sandbox.datasets"><span class="nn">sandbox.datasets</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../../api/sandbox/datasets/rtf/index.html#module-sandbox.datasets.rtf" title="sandbox.datasets.rtf"><span class="n">rtf</span></a>

<span class="n">df</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../../api/sandbox/datasets/rtf/index.html#sandbox.datasets.rtf.load" title="sandbox.datasets.rtf.load"><span class="n">rtf</span><span class="o">.</span><span class="n">load</span></a><span class="p">()</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="numpy"><span class="nn">numpy</span></a> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://pandas.pydata.org/pandas-docs/stable/index.html#module-pandas" title="pandas"><span class="nn">pandas</span></a> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>


<span class="k">class</span> <span class="nc">LocalLinearTrend</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.statespace.mlemodel.MLEModel.html#statsmodels.tsa.statespace.mlemodel.MLEModel" title="statsmodels.tsa.statespace.mlemodel.MLEModel"><span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">statespace</span><span class="o">.</span><span class="n">MLEModel</span></a><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">initialization</span><span class="o">=</span><span class="s2">"approximate_diffuse"</span><span class="p">):</span>
        <span class="c1"># 状態変数がローカル成分とそのトレンド成分の2つ.</span>
        <span class="c1"># 推定されるべき状態変数の分散の数は2つ.</span>
        <span class="n">k_states</span> <span class="o">=</span> <span class="n">k_posdef</span> <span class="o">=</span> <span class="mi">2</span>

        <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#super" title="super"><span class="nb">super</span></a><span class="p">(</span><span class="n">LocalLinearTrend</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">endog</span><span class="p">,</span> <span class="n">k_states</span><span class="o">=</span><span class="n">k_states</span><span class="p">,</span> <span class="n">k_posdef</span><span class="o">=</span><span class="n">k_posdef</span><span class="p">,</span> <span class="n">initialization</span><span class="o">=</span><span class="n">initialization</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># statespace matricesの設定.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"design"</span><span class="p">]</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"transition"</span><span class="p">]</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"selection"</span><span class="p">]</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.eye.html#numpy.eye" title="numpy.eye"><span class="n">np</span><span class="o">.</span><span class="n">eye</span></a><span class="p">(</span><span class="n">k_states</span><span class="p">)</span>

    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#property" title="property"><span class="nd">@property</span></a>
    <span class="k">def</span> <span class="nf">param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">"sigma2.observation"</span><span class="p">,</span> <span class="s2">"sigma2.level"</span><span class="p">,</span> <span class="s2">"sigma2.trend"</span><span class="p">]</span>

    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#property" title="property"><span class="nd">@property</span></a>
    <span class="k">def</span> <span class="nf">start_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.std.html#numpy.std" title="numpy.std"><span class="n">np</span><span class="o">.</span><span class="n">std</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="o">.</span><span class="n">k_posdef</span><span class="p">)</span>

    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#property" title="property"><span class="nd">@property</span></a>
    <span class="k">def</span> <span class="nf">state_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"level"</span><span class="p">,</span> <span class="s2">"trend"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">names</span>

    <span class="c1"># 分散は必ず正となるのでパラメータを2乗して制約化.</span>
    <span class="k">def</span> <span class="nf">transform_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unconstrained</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unconstrained</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># transformで2乗したので元に戻す.</span>
    <span class="k">def</span> <span class="nf">untransform_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constrained</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">constrained</span> <span class="o">**</span> <span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#super" title="super"><span class="nb">super</span></a><span class="p">(</span><span class="n">LocalLinearTrend</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"obs_cov"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[(</span><span class="s2">"state_cov"</span><span class="p">,)</span> <span class="o">+</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.diag_indices.html#numpy.diag_indices" title="numpy.diag_indices"><span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="o">.</span><span class="n">k_posdef</span><span class="p">)]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">endog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"Finland"</span><span class="p">])</span>

<span class="c1"># モデリング</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">LocalLinearTrend</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>

<span class="c1"># fittingと結果のサマリ表示.</span>
<span class="n">mod_ret</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mod_ret</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Statespace Model Results</caption>
<tr>
<th>Dep. Variable:</th> <td>Finland</td> <th>  No. Observations:  </th> <td>34</td>
</tr>
<tr>
<th>Model:</th> <td>LocalLinearTrend</td> <th>  Log Likelihood     </th> <td>11.857</td>
</tr>
<tr>
<th>Date:</th> <td>Tue, 02 Aug 2022</td> <th>  AIC                </th> <td>-17.713</td>
</tr>
<tr>
<th>Time:</th> <td>15:19:38</td> <th>  BIC                </th> <td>-13.134</td>
</tr>
<tr>
<th>Sample:</th> <td>12-31-1970</td> <th>  HQIC               </th> <td>-16.152</td>
</tr>
<tr>
<th></th> <td>- 12-31-2003</td> <th> </th> <td> </td>
</tr>
<tr>
<th>Covariance Type:</th> <td>opg</td> <th> </th> <td> </td>
</tr>
</table>
<table class="simpletable">
<tr>
<td></td> <th>coef</th> <th>std err</th> <th>z</th> <th>P&gt;|z|</th> <th>[0.025</th> <th>0.975]</th>
</tr>
<tr>
<th>sigma2.observation</th> <td>    0.0010</td> <td>    0.003</td> <td>    0.346</td> <td> 0.730</td> <td>   -0.005</td> <td>    0.007</td>
</tr>
<tr>
<th>sigma2.level</th> <td>    0.0074</td> <td>    0.005</td> <td>    1.564</td> <td> 0.118</td> <td>   -0.002</td> <td>    0.017</td>
</tr>
<tr>
<th>sigma2.trend</th> <td> 2.498e-11</td> <td>    0.000</td> <td> 1.67e-07</td> <td> 1.000</td> <td>   -0.000</td> <td>    0.000</td>
</tr>
</table>
<table class="simpletable">
<tr>
<th>Ljung-Box (L1) (Q):</th> <td>0.00</td> <th>  Jarque-Bera (JB):  </th> <td>0.46</td>
</tr>
<tr>
<th>Prob(Q):</th> <td>0.95</td> <th>  Prob(JB):          </th> <td>0.79</td>
</tr>
<tr>
<th>Heteroskedasticity (H):</th> <td>0.83</td> <th>  Skew:              </th> <td>-0.02</td>
</tr>
<tr>
<th>Prob(H) (two-sided):</th> <td>0.77</td> <th>  Kurtosis:          </th> <td>2.43</td>
</tr>
</table><br/><br/>Warnings:<br/>[1] Covariance matrix calculated using the outer product of gradients (complex-step).</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 観測値, 状態変数 (ローカル・トレンド) のプロット.</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># 観測値・スムージング値</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">mod_ret</span><span class="o">.</span><span class="n">fittedvalues</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Fitted values"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Observations"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
    <span class="n">bottom</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#min" title="min"><span class="nb">min</span></a><span class="p">(</span><span class="n">mod_ret</span><span class="o">.</span><span class="n">fittedvalues</span><span class="p">[</span><span class="n">mod_ret</span><span class="o">.</span><span class="n">fittedvalues</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">endog</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">*</span> <span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>

<span class="c1"># ローカル値 (フィルタリング値とスムージング値)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">)</span>
<span class="n">mod_ret</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">filtered</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Filterd level"</span>
<span class="p">)</span>
<span class="n">mod_ret</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Smoothed level"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>

<span class="c1"># トレンド値 (フィルタリング値とスムージング値)</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">)</span>
<span class="n">mod_ret</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">filtered</span><span class="o">.</span><span class="n">trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Filterd trend"</span>
<span class="p">)</span>
<span class="n">mod_ret</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">smoothed</span><span class="o">.</span><span class="n">trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Smoothed trend"</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_46_0.png" src="../../_images/ssm_46_0.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 予測期間 (in-sample / out-of-sample問わず)および回帰成分がある場合はそれとセットで引数にする.</span>
<span class="c1"># 予測結果インスタンスがリターン。</span>
<span class="n">pred_ret</span> <span class="o">=</span> <span class="n">mod_ret</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span>
    <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"2004-12-31"</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"2014-12-31"</span><span class="p">),</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>

<span class="c1"># 予測値のデータフレーム.</span>
<span class="n">df_predict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred_ret</span><span class="o">.</span><span class="n">predicted_mean</span><span class="p">)</span>

<span class="c1"># 信頼区間のデータフレーム.</span>
<span class="n">predict_ci</span> <span class="o">=</span> <span class="n">pred_ret</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="c1"># 予測値と信頼区間を格納したデータフレーム.</span>
<span class="n">df_predict</span> <span class="o">=</span> <span class="n">df_predict</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predict_ci</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 学習期間, 予測期間のプロット.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># 学習期間のスムージング値</span>
<span class="n">mod_ret</span><span class="o">.</span><span class="n">fittedvalues</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Fitted values"</span><span class="p">)</span>

<span class="c1"># 実績の散布</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Observations"</span><span class="p">)</span>

<span class="c1"># 予測期間の信頼区間</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">df_predict</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">df_predict</span><span class="p">[</span><span class="s2">"lower Finland"</span><span class="p">],</span>
    <span class="n">df_predict</span><span class="p">[</span><span class="s2">"upper Finland"</span><span class="p">],</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 予測値</span>
<span class="n">pred_ret</span><span class="o">.</span><span class="n">predicted_mean</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="c1"># y軸の範囲をちょうど良い範囲に絞る.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
    <span class="n">bottom</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#min" title="min"><span class="nb">min</span></a><span class="p">(</span>
        <span class="n">mod_ret</span><span class="o">.</span><span class="n">fittedvalues</span><span class="p">[</span><span class="n">mod_ret</span><span class="o">.</span><span class="n">fittedvalues</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">endog</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">df_predict</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="o">*</span> <span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_48_0.png" src="../../_images/ssm_48_0.png"/>
</div>
</div>
</section>
<section id="mlemode">
<h3>5.4 例 (MLEModeでのカスタム構築: 時変回帰モデル)<a class="headerlink" href="#mlemode" title="Permalink to this headline">#</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    y_t &amp;= x_t \beta_{x,t} + w_t \beta_{w,t} + d + \varepsilon_t \quad \varepsilon_t \sim N(0, \sigma_{\varepsilon^2}) \\
    \beta_{x,t} &amp;= \beta_{x,t-1} + \zeta_{x,t} \quad \zeta_{x,t} \sim N(0, \sigma_{\beta,x}^2) \\
    \beta_{w,t} &amp;= \beta_{w,t-1} + \zeta_{w,t} \quad \zeta_{w,t} \sim N(0, \sigma_{\beta,w}^2)
\end{align*}
\end{split}\]</div>
<p>のモデルを考える. 回帰係数は誤差項が存在するので<strong>時変</strong> (time-varying) となっている. 上記を行列表現すると</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    y_t &amp;= 
        \begin{bmatrix}
            x_t &amp; w_t
        \end{bmatrix}
        \begin{bmatrix}
            \beta_{x,t} \\
            \beta_{w,t}
        \end{bmatrix}
        + d + \varepsilon_t \quad \varepsilon_t \sim N(0, \sigma_{\varepsilon^2}) \\
    \begin{bmatrix}
        \beta_{x,t} \\
        \beta_{w,t}
    \end{bmatrix} &amp;=
        \begin{bmatrix}
            1 &amp; 0 \\
            0 &amp; 1
        \end{bmatrix}
        \begin{bmatrix}
            \beta_{x,t-1} \\
            \beta_{w,t-1}
        \end{bmatrix} +
        \begin{bmatrix}
            1 &amp; 0 \\
            0 &amp; 1
        \end{bmatrix}
        \begin{bmatrix}
            \zeta_{x,t} \\
            \zeta_{w,t}
        \end{bmatrix} \quad
        \begin{bmatrix}
            \zeta_{x,t} \\
            \zeta_{w,t}
        \end{bmatrix} \sim
        N \biggl( 
            \begin{bmatrix}
                0 \\
                0
            \end{bmatrix},
            \begin{bmatrix}
                \sigma_{\beta,x}^2 &amp; 0 \\
                0                  &amp; \sigma_{\beta,w}^2
            \end{bmatrix}
        \biggr)
\end{align*}
\end{split}\]</div>
<p>より</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">k_states</span></code>, <code class="docutils literal notranslate"><span class="pre">k_posdef</span></code> は 2</p></li>
<li><p>状態変数として扱っているが回帰係数なので <code class="docutils literal notranslate"><span class="pre">k_exog</span></code> は 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssm["design"]</span></code> <span class="math notranslate nohighlight">\( = Z_t = \begin{bmatrix} x_t &amp; w_t \end{bmatrix}\)</span> とし行列の次元としては <span class="math notranslate nohighlight">\(1 \times 2 \times \text{観測値の数}\)</span> (<code class="docutils literal notranslate"><span class="pre">k_endog</span></code> × <code class="docutils literal notranslate"><span class="pre">k_staes</span></code> × <code class="docutils literal notranslate"><span class="pre">nobs</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssm["transition"]</span></code> <span class="math notranslate nohighlight">\( = T_t = \begin{bmatrix} 1 &amp; 0 \\ 0 &amp; 1 \end{bmatrix}\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssm["selection"]</span></code> <span class="math notranslate nohighlight">\( = R_t = \begin{bmatrix} 1 &amp; 0 \\ 0 &amp; 1 \end{bmatrix}\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code> <span class="math notranslate nohighlight">\(=\begin{bmatrix} d &amp; \sigma_\varepsilon^2 &amp; \sigma_{\beta,x}^2 &amp; \sigma_{\beta,w}^2 \end{bmatrix}\)</span></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_data_for_model1</span><span class="p">(</span><span class="n">nobs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">54321</span><span class="p">):</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">var_y</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">var_coeff_x</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">var_coeff_w</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="n">x_t</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">)</span>
    <span class="n">w_t</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">var_y</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">)</span>

    <span class="n">beta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">var_coeff_x</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">))</span>
    <span class="n">beta_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">var_coeff_w</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">))</span>

    <span class="n">y_t</span> <span class="o">=</span> <span class="n">beta_x</span> <span class="o">*</span> <span class="n">x_t</span> <span class="o">+</span> <span class="n">beta_w</span> <span class="o">*</span> <span class="n">w_t</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="n">eps</span>
    <span class="k">return</span> <span class="n">y_t</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">w_t</span><span class="p">,</span> <span class="n">beta_x</span><span class="p">,</span> <span class="n">beta_w</span>


<span class="n">y_t</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">w_t</span><span class="p">,</span> <span class="n">beta_x</span><span class="p">,</span> <span class="n">beta_w</span> <span class="o">=</span> <span class="n">generate_data_for_model1</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テストデータとして作成した観測値, 回帰係数のプロット.</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># 観測値</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Observation"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>

<span class="c1"># beta_x</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beta_x</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"beta_x"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>

<span class="c1"># beta_w</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beta_w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"beta_w"</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_51_0.png" src="../../_images/ssm_51_0.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TVRegression</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">statespace</span><span class="o">.</span><span class="n">MLEModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_t</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">initialization</span><span class="o">=</span><span class="s2">"diffuse"</span><span class="p">):</span>
        <span class="n">k_states</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">k_posdef</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">k_exog</span> <span class="o">=</span> <span class="mi">2</span>

        <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#super" title="super"><span class="nb">super</span></a><span class="p">(</span><span class="n">TVRegression</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">endog</span><span class="o">=</span><span class="n">y_t</span><span class="p">,</span>
            <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span>
            <span class="n">k_states</span><span class="o">=</span><span class="n">k_states</span><span class="p">,</span>
            <span class="n">k_posdef</span><span class="o">=</span><span class="n">k_posdef</span><span class="p">,</span>
            <span class="n">initialization</span><span class="o">=</span><span class="n">initialization</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># インスタンス変数としてセットする必要がある.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_exog</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"design"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"selection"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"transition"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_states</span><span class="p">)</span>

        <span class="c1"># params = [intercept.obs, sigma2.obs, sigam2.x.coeff, sigma2.w.coeff]</span>
        <span class="c1"># においてsigma2は必ず正となるので, transform_paramsで処理する対象とする.</span>
        <span class="c1"># params のインデックスをここで設定しておく.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive_parameters</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#slice" title="slice"><span class="nb">slice</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># 切片は観測方程式と同じ線形回帰を解いて初期値とする.</span>
    <span class="c1"># ただし, y_t に欠損値が存在すると推定にエラーが発生し, 状態推定においても不具合が発生する...</span>
    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#property" title="property"><span class="nd">@property</span></a>
    <span class="k">def</span> <span class="nf">start_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="c1"># 計算の上では必須ではないが扱いやすいように推定パラメータに名称を付与.</span>
    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#property" title="property"><span class="nd">@property</span></a>
    <span class="k">def</span> <span class="nf">param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">"intercept.obs"</span><span class="p">,</span>
            <span class="s2">"sigma2.obs"</span><span class="p">,</span>
            <span class="s2">"sigma2.x.coeff"</span><span class="p">,</span>
            <span class="s2">"sigma2.w.coeff"</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># 計算の上では必須ではないが扱いやすいように状態変数に名称を付与.</span>
    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#property" title="property"><span class="nd">@property</span></a>
    <span class="k">def</span> <span class="nf">state_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"beta.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_exog</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">names</span>

    <span class="k">def</span> <span class="nf">transform_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unconstrained</span><span class="p">):</span>
        <span class="n">constrained</span> <span class="o">=</span> <span class="n">unconstrained</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">constrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_parameters</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">constrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_parameters</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">constrained</span>

    <span class="k">def</span> <span class="nf">untransform_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constrained</span><span class="p">):</span>
        <span class="n">unconstrained</span> <span class="o">=</span> <span class="n">constrained</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">unconstrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_parameters</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">unconstrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_parameters</span><span class="p">]</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">unconstrained</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#super" title="super"><span class="nb">super</span></a><span class="p">(</span><span class="n">TVRegression</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"obs_intercept"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"obs_cov"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s2">"state_cov"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>

    <span class="c1"># statsmodelsでは回帰成分ありでの状態空間モデルを定義する場合,</span>
    <span class="c1"># fitでは不要だがout-of-sample forecastingの時 (ex. get_prediction) に必要.</span>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># MLEModel</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone_from_init_kwds</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.model_selection" title="sklearn.model_selection"><span class="nn">sklearn.model_selection</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html#sklearn.model_selection.train_test_split" title="sklearn.model_selection.train_test_split"><span class="n">train_test_split</span></a>

<span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">w_train</span><span class="p">,</span> <span class="n">w_test</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html#sklearn.model_selection.train_test_split" title="sklearn.model_selection.train_test_split"><span class="n">train_test_split</span></a><span class="p">(</span>
    <span class="n">y_t</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">w_t</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span>
<span class="p">)</span>

<span class="n">mod</span> <span class="o">=</span> <span class="n">TVRegression</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x_train</span><span class="p">,</span> <span class="n">w_train</span><span class="p">])</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">res</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> This problem is unconstrained.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RUNNING THE L-BFGS-B CODE

           * * *

Machine precision = 2.220D-16
 N =            4     M =           10

At X0         0 variables are exactly at the bounds

At iterate    0    f=  1.93831D+00    |proj g|=  4.45116D-01

At iterate    5    f=  1.22291D+00    |proj g|=  4.62909D+00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>At iterate   10    f=  4.93695D-01    |proj g|=  3.44678D-01

At iterate   15    f=  4.08063D-01    |proj g|=  2.96812D-02

At iterate   20    f=  4.08015D-01    |proj g|=  4.38519D-05

           * * *

Tit   = total number of iterations
Tnf   = total number of function evaluations
Tnint = total number of segments explored during Cauchy searches
Skip  = number of BFGS updates skipped
Nact  = number of active bounds at final generalized Cauchy point
Projg = norm of the final projected gradient
F     = final function value

           * * *

   N    Tit     Tnf  Tnint  Skip  Nact     Projg        F
    4     20     45      1     0     0   4.385D-05   4.080D-01
  F =  0.40801504275767103     

CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH             
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> Warning:  more than 10 function and gradient
   evaluations in the last line search.  Termination
   may possibly be caused by a bad search direction.
</pre></div>
</div>
<div class="output text_html"><table class="simpletable">
<caption>Statespace Model Results</caption>
<tr>
<th>Dep. Variable:</th> <td>y</td> <th>  No. Observations:  </th> <td>900</td>
</tr>
<tr>
<th>Model:</th> <td>TVRegression</td> <th>  Log Likelihood     </th> <td>-367.214</td>
</tr>
<tr>
<th>Date:</th> <td>Tue, 02 Aug 2022</td> <th>  AIC                </th> <td>746.427</td>
</tr>
<tr>
<th>Time:</th> <td>15:19:41</td> <th>  BIC                </th> <td>775.241</td>
</tr>
<tr>
<th>Sample:</th> <td>0</td> <th>  HQIC               </th> <td>757.434</td>
</tr>
<tr>
<th></th> <td> - 900</td> <th> </th> <td> </td>
</tr>
<tr>
<th>Covariance Type:</th> <td>opg</td> <th> </th> <td> </td>
</tr>
</table>
<table class="simpletable">
<tr>
<td></td> <th>coef</th> <th>std err</th> <th>z</th> <th>P&gt;|z|</th> <th>[0.025</th> <th>0.975]</th>
</tr>
<tr>
<th>intercept.obs</th> <td>    4.9833</td> <td>    0.028</td> <td>  181.038</td> <td> 0.000</td> <td>    4.929</td> <td>    5.037</td>
</tr>
<tr>
<th>sigma2.obs</th> <td>    0.0890</td> <td>    0.005</td> <td>   17.920</td> <td> 0.000</td> <td>    0.079</td> <td>    0.099</td>
</tr>
<tr>
<th>sigma2.x.coeff</th> <td>    0.0119</td> <td>    0.003</td> <td>    4.027</td> <td> 0.000</td> <td>    0.006</td> <td>    0.018</td>
</tr>
<tr>
<th>sigma2.w.coeff</th> <td>    0.0161</td> <td>    0.003</td> <td>    4.777</td> <td> 0.000</td> <td>    0.009</td> <td>    0.023</td>
</tr>
</table>
<table class="simpletable">
<tr>
<th>Ljung-Box (L1) (Q):</th> <td>0.02</td> <th>  Jarque-Bera (JB):  </th> <td>2.55</td>
</tr>
<tr>
<th>Prob(Q):</th> <td>0.90</td> <th>  Prob(JB):          </th> <td>0.28</td>
</tr>
<tr>
<th>Heteroskedasticity (H):</th> <td>1.03</td> <th>  Skew:              </th> <td>0.10</td>
</tr>
<tr>
<th>Prob(H) (two-sided):</th> <td>0.78</td> <th>  Kurtosis:          </th> <td>3.17</td>
</tr>
</table><br/><br/>Warnings:<br/>[1] Covariance matrix calculated using the outer product of gradients (complex-step).</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 予測期間 (in-sample / out-of-sample問わず)および回帰成分がある場合はそれとセットで引数にする.</span>
<span class="c1"># 予測結果インスタンスがリターン。</span>
<span class="n">pred_ret</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">999</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x_test</span><span class="p">,</span> <span class="n">w_test</span><span class="p">])</span>

<span class="c1"># 予測値のデータフレーム.</span>
<span class="c1"># インプットがnumpy.ndarrayでnameが定義されていないので, statsmodelsの内部でもpredicted_mean</span>
<span class="c1"># にnameが定義されていないため明示的に設定する.</span>
<span class="n">df_predict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred_ret</span><span class="o">.</span><span class="n">predicted_mean</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"predicted mean"</span><span class="p">])</span>

<span class="c1"># 信頼区間のデータフレーム.</span>
<span class="n">predict_ci</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred_ret</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"upper"</span><span class="p">,</span> <span class="s2">"lower"</span><span class="p">])</span>

<span class="c1"># 予測値と信頼区間を格納したデータフレーム.</span>
<span class="n">df_predict</span> <span class="o">=</span> <span class="n">df_predict</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predict_ci</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 学習期間と検証期間をプロットする.</span>
<span class="c1"># 検証期間が見えやすいように学習期間は後半100個のみを可視化.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">899</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">800</span><span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"train"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"test"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">df_predict</span><span class="p">[</span><span class="s2">"predicted mean"</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">"predicted"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Time-varying regression"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="mi">900</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ssm_55_0.png" src="../../_images/ssm_55_0.png"/>
</div>
</div>
</section>
</section>
</section>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./analytics/tsa"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="arima.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">ARIMAモデル系</p>
</div>
</a>
<a class="right-next" href="../math/calculus.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">微分積分学</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By sndpgm<br/>
  
      © Copyright 2022.<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>